"use strict";(self.webpackChunknocobase_docs=self.webpackChunknocobase_docs||[]).push([[15105],{222954:function(l,n,a){a.r(n);var s=a(572269),x=a(793359),u=a(861788),_=a(719977),h=a(20190),t=a(24268),I=a(496057),p=a(585939),v=a(28484),m=a(635206),j=a(375553),b=a(156266),E=a(572333),w=a(841118),f=a(39297),y=a(868526),P=a(605019),o=a(614651),r=a(280936),i=a(667294),d=a(670914),e=a(785893);function c(){return(0,e.jsx)(o.dY,{children:(0,e.jsx)(i.Suspense,{fallback:(0,e.jsx)(r.Z,{}),children:(0,e.jsx)(e.Fragment,{children:(0,e.jsxs)("div",{className:"markdown",children:[(0,e.jsxs)("h1",{id:"middleware",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#middleware",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"Middleware"]}),(0,e.jsxs)("h2",{id:"how-to-register-middleware",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#how-to-register-middleware",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"How to register middleware?"]}),(0,e.jsx)("p",{children:d.texts[0].value}),(0,e.jsx)(t.Z,{lang:"ts",children:d.texts[1].value}),(0,e.jsx)("p",{children:d.texts[2].value}),(0,e.jsxs)("ol",{children:[(0,e.jsxs)("li",{children:[(0,e.jsx)("code",{children:d.texts[3].value}),d.texts[4].value]}),(0,e.jsxs)("li",{children:[(0,e.jsx)("code",{children:d.texts[5].value}),d.texts[6].value]}),(0,e.jsxs)("li",{children:[(0,e.jsx)("code",{children:d.texts[7].value}),d.texts[8].value]})]}),(0,e.jsxs)("h2",{id:"onion-circle-model",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#onion-circle-model",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"Onion Circle Model"]}),(0,e.jsx)(t.Z,{lang:"ts",children:d.texts[9].value}),(0,e.jsxs)("p",{children:[d.texts[10].value,(0,e.jsx)("a",{href:"http://localhost:13000/api/hello",children:d.texts[11].value}),d.texts[12].value]}),(0,e.jsx)(t.Z,{lang:"js",children:d.texts[13].value}),(0,e.jsxs)("h2",{id:"built-in-middlewares-and-execution-order",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#built-in-middlewares-and-execution-order",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"Built-in middlewares and execution order"]}),(0,e.jsxs)("ol",{children:[(0,e.jsx)("li",{children:(0,e.jsx)("code",{children:d.texts[14].value})}),(0,e.jsx)("li",{children:(0,e.jsx)("code",{children:d.texts[15].value})}),(0,e.jsx)("li",{children:(0,e.jsx)("code",{children:d.texts[16].value})}),(0,e.jsx)("li",{children:(0,e.jsx)("code",{children:d.texts[17].value})}),(0,e.jsxs)("li",{children:[(0,e.jsx)("code",{children:d.texts[18].value}),d.texts[19].value]}),(0,e.jsxs)("li",{children:[(0,e.jsx)("code",{children:d.texts[20].value}),d.texts[21].value,(0,e.jsxs)("ol",{children:[(0,e.jsxs)("li",{children:[(0,e.jsx)("code",{children:d.texts[22].value}),d.texts[23].value]}),(0,e.jsx)("li",{children:(0,e.jsx)("code",{children:d.texts[24].value})}),(0,e.jsxs)("li",{children:[(0,e.jsx)("code",{children:d.texts[25].value}),d.texts[26].value,(0,e.jsx)("ol",{children:(0,e.jsxs)("li",{children:[(0,e.jsx)("code",{children:d.texts[27].value}),d.texts[28].value]})})]}),(0,e.jsxs)("li",{children:[(0,e.jsx)("code",{children:d.texts[29].value}),d.texts[30].value]}),(0,e.jsx)("li",{children:(0,e.jsx)("code",{children:d.texts[31].value})})]})]}),(0,e.jsxs)("li",{children:[(0,e.jsx)("code",{children:d.texts[32].value}),d.texts[33].value]})]}),(0,e.jsxs)("p",{children:[d.texts[34].value,(0,e.jsx)("code",{children:d.texts[35].value}),d.texts[36].value,(0,e.jsx)("code",{children:d.texts[37].value}),d.texts[38].value,(0,e.jsx)("code",{children:d.texts[39].value}),d.texts[40].value]}),(0,e.jsx)(t.Z,{lang:"ts",children:d.texts[41].value}),(0,e.jsx)("p",{children:d.texts[42].value}),(0,e.jsxs)("ol",{children:[(0,e.jsxs)("li",{children:[d.texts[43].value,(0,e.jsx)("code",{children:d.texts[44].value}),d.texts[45].value]}),(0,e.jsxs)("li",{children:[d.texts[46].value,(0,e.jsx)("code",{children:d.texts[47].value}),d.texts[48].value]}),(0,e.jsxs)("li",{children:[d.texts[49].value,(0,e.jsx)("code",{children:d.texts[50].value})]})]}),(0,e.jsx)(t.Z,{lang:"ts",children:d.texts[51].value}),(0,e.jsxs)("p",{children:[d.texts[52].value,(0,e.jsx)("a",{href:"http://localhost:13000/api/hello",children:d.texts[53].value}),d.texts[54].value]}),(0,e.jsx)(t.Z,{lang:"js",children:d.texts[55].value}),(0,e.jsxs)("p",{children:[d.texts[56].value,(0,e.jsx)("a",{href:"http://localhost:13000/api/test:list",children:d.texts[57].value}),d.texts[58].value]}),(0,e.jsx)(t.Z,{lang:"js",children:d.texts[59].value}),(0,e.jsxs)("h3",{id:"resource-undefined-middlewares-added-by-resourceruse-will-not-be-executed",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#resource-undefined-middlewares-added-by-resourceruse-will-not-be-executed",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"Resource undefined, middlewares added by resourcer.use() will not be executed"]}),(0,e.jsx)(t.Z,{lang:"ts",children:d.texts[60].value}),(0,e.jsxs)("p",{children:[d.texts[61].value,(0,e.jsx)("a",{href:"http://localhost:13000/api/hello",children:d.texts[62].value}),d.texts[63].value]}),(0,e.jsx)(t.Z,{lang:"js",children:d.texts[64].value}),(0,e.jsx)("p",{children:d.texts[65].value}),(0,e.jsxs)("h2",{id:"middleware-usage",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#middleware-usage",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"Middleware Usage"]}),(0,e.jsx)("p",{children:d.texts[66].value}),(0,e.jsxs)("h2",{id:"example",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#example",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"Example"]}),(0,e.jsx)("ul",{children:(0,e.jsxs)("li",{children:[(0,e.jsx)("a",{href:"https://github.com/nocobase/nocobase/blob/main/packages/samples/ratelimit/",children:d.texts[67].value}),d.texts[68].value]})})]})})})})}n.default=c},670914:function(l,n,a){a.r(n),a.d(n,{texts:function(){return s}});const s=[{value:"The registration method for middleware is usually written in the load method",paraId:0,tocIndex:1},{value:`export class MyPlugin extends Plugin {
  load() {
    this.app.acl.use();
    this.app.resourcer.use();
    this.app.use();
  }
}
`,paraId:1,tocIndex:1},{value:"Notes.",paraId:2,tocIndex:1},{value:"app.acl.use()",paraId:3,tocIndex:1},{value:" Add a resource-permission-level middleware to be executed before permission determination",paraId:3,tocIndex:1},{value:"app.resourcer.use()",paraId:3,tocIndex:1},{value:" Adds a resource-level middleware that is executed only when a defined resource is requested",paraId:3,tocIndex:1},{value:"app.use()",paraId:3,tocIndex:1},{value:" Add an application-level middleware to be executed on every request",paraId:3,tocIndex:1},{value:`app.use(async (ctx, next) => {
  ctx.body = ctx.body || [];
  ctx.body.push(1);
  await next();
  ctx.body.push(2);
});

app.use(async (ctx, next) => {
  ctx.body = ctx.body || [];
  ctx.body.push(3);
  await next();
  ctx.body.push(4);
});
`,paraId:4,tocIndex:2},{value:"Visit ",paraId:5,tocIndex:2},{value:"http://localhost:13000/api/hello",paraId:5,tocIndex:2},{value:" to see that the browser responds with the following data",paraId:5,tocIndex:2},{value:`{"data": [1,3,4,2]}
`,paraId:6,tocIndex:2},{value:"cors",paraId:7,tocIndex:3},{value:"bodyParser",paraId:7,tocIndex:3},{value:"i18n",paraId:7,tocIndex:3},{value:"dataWrapping",paraId:7,tocIndex:3},{value:"db2resource",paraId:7,tocIndex:3},{value:" 6.",paraId:7,tocIndex:3},{value:"restApi",paraId:7,tocIndex:3},{value:` 1.
`,paraId:7,tocIndex:3},{value:"parseToken",paraId:8,tocIndex:3},{value:" 2.",paraId:8,tocIndex:3},{value:"checkRole",paraId:8,tocIndex:3},{value:"acl",paraId:8,tocIndex:3},{value:` 1.
`,paraId:8,tocIndex:3},{value:"acl.use()",paraId:9,tocIndex:3},{value:" Additional middleware added",paraId:9,tocIndex:3},{value:"resourcer.use()",paraId:8,tocIndex:3},{value:" Additional middleware added",paraId:8,tocIndex:3},{value:"action handler",paraId:8,tocIndex:3},{value:"app.use()",paraId:7,tocIndex:3},{value:" Additional middleware added",paraId:7,tocIndex:3},{value:"You can also use ",paraId:10,tocIndex:3},{value:"before",paraId:10,tocIndex:3},{value:" or ",paraId:10,tocIndex:3},{value:"after",paraId:10,tocIndex:3},{value:" to insert the middleware into the location of one of the preceding ",paraId:10,tocIndex:3},{value:"tag",paraId:10,tocIndex:3},{value:", e.g.",paraId:10,tocIndex:3},{value:`app.use(m1, { tag: 'restApi' });
app.resourcer.use(m2, { tag: 'parseToken' });
app.resourcer.use(m3, { tag: 'checkRole' });
// m4 will come before m1
app.use(m4, { before: 'restApi' });
// m5 will be inserted between m2 and m3
app.resourcer.use(m5, { after: 'parseToken', before: 'checkRole' });
`,paraId:11,tocIndex:3},{value:"If no location is specifically specified, the order of execution of the added middlewares is",paraId:12,tocIndex:3},{value:"middlewares added by ",paraId:13,tocIndex:3},{value:"acl.use",paraId:13,tocIndex:3},{value:" will be executed first",paraId:13,tocIndex:3},{value:"then the ones added by ",paraId:13,tocIndex:3},{value:"resourcer.use",paraId:13,tocIndex:3},{value:", including the middleware handler and action handler",paraId:13,tocIndex:3},{value:"and finally the ones added by ",paraId:13,tocIndex:3},{value:"app.use",paraId:13,tocIndex:3},{value:`app.use(async (ctx, next) => {
  ctx.body = ctx.body || [];
  ctx.body.push(1);
  await next();
  ctx.body.push(2);
});

app.resourcer.use(async (ctx, next) => {
  ctx.body = ctx.body || [];
  ctx.body.push(3);
  await next();
  ctx.body.push(4);
});

app.acl.use(async (ctx, next) => {
  ctx.body = ctx.body || [];
  ctx.body.push(5);
  await next();
  ctx.body.push(6);
});

app.resourcer.define({
  name: 'test',
  actions: {
    async list(ctx, next) {
      ctx.body = ctx.body || [];
      ctx.body.push(7);
      await next();
      ctx.body.push(8);
    },
  },
});
`,paraId:14,tocIndex:3},{value:"Visit ",paraId:15,tocIndex:3},{value:"http://localhost:13000/api/hello",paraId:15,tocIndex:3},{value:" to see that the browser responds with the data",paraId:15,tocIndex:3},{value:`{"data": [1,2]}
`,paraId:16,tocIndex:3},{value:"Visiting ",paraId:17,tocIndex:3},{value:"http://localhost:13000/api/test:list",paraId:17,tocIndex:3},{value:" to see, the browser responds with the following data",paraId:17,tocIndex:3},{value:`{"data": [5,3,7,1,2,8,4,6]}
`,paraId:18,tocIndex:3},{value:`app.use(async (ctx, next) => {
  ctx.body = ctx.body || [];
  ctx.body.push(1);
  await next();
  ctx.body.push(2);
});

app.resourcer.use(async (ctx, next) => {
  ctx.body = ctx.body || [];
  ctx.body.push(3);
  await next();
  ctx.body.push(4);
});
`,paraId:19,tocIndex:4},{value:"Visit ",paraId:20,tocIndex:4},{value:"http://localhost:13000/api/hello",paraId:20,tocIndex:4},{value:" to see that the browser responds with the following data",paraId:20,tocIndex:4},{value:`{"data": [1,2]}
`,paraId:21,tocIndex:4},{value:"In the above example, the hello resource is not defined and will not enter the resourcer, so the middleware in the resourcer will not be executed",paraId:22,tocIndex:4},{value:"TODO",paraId:23,tocIndex:5},{value:"samples/ratelimit",paraId:24,tocIndex:6},{value:" IP rate-limiting",paraId:24,tocIndex:6}]}}]);
