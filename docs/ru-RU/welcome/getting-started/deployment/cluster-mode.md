# Cluster Mode

<PluginInfo licenseBundled="enterprise" plugins="pubsub-adapter-redis,lock-adapter-redis"></PluginInfo>

Начиная с версии v1.6.0, NocoBase поддерживает запуск приложений в режиме кластера. Когда приложение работает в режиме кластера, его производительность в обработке параллельных запросов может быть улучшена за счет использования нескольких экземпляров и многопоточного режима.

## Архитектура системы

![20241231010814](https://static-docs.nocobase.com/20241231010814.png)

### Компоненты архитектуры

Текущий режим кластера направлен только на экземпляры приложения, исключая внешние сервисы такие как База данных, Redis итд. Если у Вас есть необходимость развернуть дополнительные компоненты в режиме кластера, Вам нужно решить это самостоятельно.

#### Кластер приложения

Поскольку текущий режим кластера направлен только на экземпляры приложения, база данных в настоящее время поддерживает только один узел. Для конфигураций, таких как мастер-слейв базы данных, это должно быть реализовано через промежуточное ПО, обеспечивая прозрачность для приложения NocoBase.

#### База Данных

Кластер приложения представляет собой набор экземпляров приложений NocoBase, где каждый экземпляр может быть независимым узлом или несколькими процессами приложения, работающими на одной машине в многопоточном режиме, или комбинацией обоих вариантов.

#### Кэширование, Синхронизация Сообщений и Распределенные Замки

Режим кластера NocoBase зависит от промежуточного ПО, таких как кэширование, синхронизация сообщений и распределенные замки, для обеспечения связи и координации между кластерами. В настоящее время предварительно поддерживается Redis в качестве промежуточного ПО для этих функций.

#### Нагрузочное Балансирование

Режим кластера NocoBase требует наличия балансировщика для распределения запросов и выполнения проверок состояния и перенаправления при отказе для экземпляров приложения. Эту часть следует выбрать и настроить в соответствии с архитектурой вашего кластера.

## Шаги Развертывания

### Подготовка Инфраструктуры

#### Нагрузочный Балансировщик

На примере использования Nginx как балансировщика, добавьте следующее содержимое в файл конфигурации:
```
upstream myapp {
    # ip_hash; # Can be used for session persistence, once enabled, requests from the same client will always be sent to the same backend server.
    server 172.31.0.1:13000; # Internal node 1
    server 172.31.0.2:13000; # Internal node 2
    server 172.31.0.3:13000; # Internal node 3
}

server {
    listen 80;

    location / {
        # Use the defined upstream for load balancing
        proxy_pass http://myapp;
        # ... other configurations
    }
}
```

Это означает, что запросы проксируются в обратном направлении и распределяются между различными серверными узлами для обработки.
Конфигурации балансировщиков нагрузки, предоставляемые другими облачными провайдерами, можно найти в их соответствующей технической документации.

#### Служба Redis

Запустите службу Redis во внутренней сети кластера (или в Kubernetes).
Также возможно раздельное включение нескольких экземпляров Redis в зависимости от задач: для кэширования, передачи синхронизирующих сообщений и реализации распределённых блокировок.

#### Локальное хранилище (необязательно)

Если используется локальное хранилище, при работе в многосерверном режиме необходимо примонтировать его как общую директорию, доступную для всех узлов.
В противном случае локальное хранилище не будет синхронизироваться автоматически и не сможет использоваться корректно.

Если локальное хранилище не используется, то после запуска приложения необходимо настроить облачное файловое хранилище как хранилище по умолчанию, а логотип приложения (и другие загружаемые файлы) перенести в это облачное хранилище.

### Подготовка связанных плагинов

| Функция                  | Плагин                                |
|--------------------------|---------------------------------------|
| Caching                  | Built-in                              |
| Synchronization Messages | @nocobase/plugin-pubsub-adapter-redis |
| Distributed Lock         | @nocobase/plugin-lock-adapter-redis   |

:::info{title=Tip}
Так же, как и в односерверном режиме, при корректно настроенных переменных окружения коммерческой платформы плагинов, необходимые плагины будут автоматически загружены при запуске приложения.
:::

### Настройка переменных окружения

Помимо основных переменных окружения, следующие переменные должны быть **одинаково настроены на всех узлах**.

#### Ключ приложения

Ключ, используемый для генерации JWT-токенов при входе пользователя. Рекомендуется использовать случайную строку.

```ini
APP_KEY=


#### Многоядерный режим

```ini
# Enable PM2 multi-core mode
# CLUSTER_MODE=max # По умолчанию отключено — необходимо настроить вручную.
```

#### Кэширование

```ini
# Адаптер кэша; в кластерном режиме обязательно указывается значение redis (по умолчанию используется memory)
CACHE_DEFAULT_STORE=redis

# Адрес подключения к Redis для кэширования; необходимо задать вручную
CACHE_REDIS_URL=

```

#### Синхронизация сообщений

```ini
# Адрес подключения к Redis для адаптера синхронизации; по умолчанию — redis://localhost:6379/0, если не указано
PUBSUB_ADAPTER_REDIS_URL=

```

#### Распределённая блокировка

```ini
# Адаптер блокировок; в кластерном режиме обязательно указывается значение redis (по умолчанию используется локальная блокировка в памяти)
LOCK_ADAPTER_DEFAULT=redis

# Адрес подключения к Redis для блокировок; по умолчанию — redis://localhost:6379/0, если не указано
LOCK_ADAPTER_REDIS_URL=
```

:::info{title=Tip}
Как правило, все связанные адаптеры могут использовать один и тот же экземпляр Redis,  
однако **рекомендуется использовать разные базы данных**, чтобы избежать возможных конфликтов ключей.

```ini
CACHE_REDIS_URL=redis://localhost:6379/0
PUBSUB_ADAPTER_REDIS_URL=redis://localhost:6379/1
LOCK_ADAPTER_REDIS_URL=redis://localhost:6379/2
```
:::

#### Включение встроенных плагинов

```ini
# Встроенные плагины, которые необходимо включить
APPEND_PRESET_BUILT_IN_PLUGINS=lock-adapter-redis,pubsub-adapter-redis
```

### Запуск приложения

При первом запуске приложения необходимо **сначала запустить один из узлов**  
и дождаться установки и активации всех плагинов, прежде чем запускать остальные.

## Обновление или обслуживание

Если необходимо обновить версию NocoBase или включить/отключить плагины, следуйте следующей инструкции.

:::warning{title=Внимание}
В кластерной среде, особенно в продакшене, следует **с осторожностью (а при возможности — избегать)** использовать функции управления плагинами и обновления версий.

На данный момент **NocoBase не поддерживает онлайн-обновление в кластерном режиме**.  
Для обеспечения целостности данных во время обновления необходимо приостановить работу всех сервисов.
:::

### Остановить текущие сервисы

Остановите все экземпляры приложения NocoBase, службы Redis и **перенаправьте весь трафик от балансировщика нагрузки на страницу с кодом 503**.

### Создать резервную копию

Перед обновлением настоятельно рекомендуется **сделать резервную копию базы данных**, чтобы избежать потери данных в случае ошибок.

### Обновить версию

См. инструкцию [по обновлению через Docker](../upgrading/docker-compose.md), чтобы обновить образ NocoBase.

### Запустить сервисы

1. Перезапустите все зависимости (например, Redis)
2. Запустите **один узел** кластера и дождитесь успешного завершения обновления
3. Проверьте работоспособность; при возникновении критических ошибок — выполните откат до предыдущей версии
4. Запустите остальные узлы
5. Перенаправьте трафик от балансировщика нагрузки обратно на кластер

