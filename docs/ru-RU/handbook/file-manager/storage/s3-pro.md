# Хранилище файлов: S3 (Pro)

<PluginInfo commercial="true" name="file-storage-s3-pro"></PluginInfo>

## Введение

На основе плагина управления файлами эта версия добавляет поддержку типов хранилищ, совместимых с протоколом S3. Любые сервисы объектного хранилища, поддерживающие протокол S3, могут быть интегрированы без дополнительных настроек — например, Amazon S3, Alibaba Cloud OSS, Tencent Cloud COS, MinIO, Cloudflare R2 и другие. Это значительно повышает совместимость и гибкость систем хранения.

## Возможности

1. **Прямая загрузка с клиента:** файлы загружаются напрямую в хранилище, минуя сервер NocoBase, что обеспечивает более эффективный и быстрый процесс загрузки.

2. **Частный доступ:** все URL-адреса файлов представляют собой временные подписанные ссылки с ограниченным сроком действия, что гарантирует безопасный и контролируемый доступ к файлам.

## Сценарии использования

1. **Управление таблицей файлов:** централизованное управление и хранение всех загруженных файлов с поддержкой различных типов и методов хранения для удобной классификации и поиска.

2. **Хранение в полях вложений:** хранение вложений, загруженных через формы или записи, с привязкой к конкретным записям данных.

## Настройка плагина

1. Включите плагин `plugin-file-storage-s3-pro`.

2. Перейдите в раздел «Настройки → Менеджер файлов», чтобы открыть настройки управления файлами.

3. Нажмите кнопку «Добавить новое» и выберите «S3 Pro».

![](https://static-docs.nocobase.com/20250102160704938.png)

4. В появившемся окне откроется подробная форма для заполнения. Ознакомьтесь с документацией по вашему провайдеру хранилища, получите необходимые параметры и введите их в форму.

![](https://static-docs.nocobase.com/20250413190828536.png)

## Настройка провайдера хранилища

### Amazon S3

#### Создание бакета

1. Перейдите в [консоль Amazon S3](https://ap-southeast-1.console.aws.amazon.com/s3/home).

2. Нажмите кнопку «Create bucket» (Создать бакет) в правой части экрана.

![Создание бакета](https://static-docs.nocobase.com/file-storage-s3-pro-1735355969452.png)

3. Укажите имя бакета (`Bucket Name`), оставьте остальные параметры по умолчанию, прокрутите вниз и нажмите кнопку **«Create»** (Создать), чтобы завершить процесс.

![Настройка бакета](https://static-docs.nocobase.com/file-storage-s3-pro-1735355969622.png)

#### Настройка CORS

1. В списке бакетов найдите и нажмите на созданный бакет, чтобы открыть его настройки.

![Список бакетов](https://static-docs.nocobase.com/file-storage-s3-pro-1735355969980.png)

2. Перейдите на вкладку «Permissions» (Разрешения) и прокрутите вниз до раздела CORS.

![Вкладка разрешений](https://static-docs.nocobase.com/file-storage-s3-pro-1735355970155.png)

3. Введите следующую конфигурацию (при необходимости настройте под себя) и сохраните:

```json
[
    {
        "AllowedHeaders": [
            "*"
        ],
        "AllowedMethods": [
            "POST",
            "PUT"
        ],
        "AllowedOrigins": [
            "*"
        ],
        "ExposeHeaders": [
            "ETag"
        ],
        "MaxAgeSeconds": 3000
    }
]
```

![Правила CORS](https://static-docs.nocobase.com/file-storage-s3-pro-1735355970494.png)

#### Получение AccessKey и SecretAccessKey

1. Нажмите кнопку «Security credentials» (Учётные данные безопасности) в правом верхнем углу.

![Учётные данные безопасности](https://static-docs.nocobase.com/file-storage-s3-pro-1735355970651.png)

2. Прокрутите до раздела «Access Keys» (Ключи доступа) и нажмите «Create Access Key» (Создать ключ доступа).

![Создать ключ доступа](https://static-docs.nocobase.com/file-storage-s3-pro-1735355970832.png)

3. Согласитесь с условиями (для рабочих сред рекомендуется использовать IAM).

![Соглашение на ключ доступа](https://static-docs.nocobase.com/file-storage-s3-pro-1735355970996.png)

4. Сохраните отображаемые Access Key и Secret Access Key.

![Данные ключа доступа](https://static-docs.nocobase.com/file-storage-s3-pro-1735355971168.png)

#### Получение параметров и настройка

1. Используйте полученные `AccessKey ID` и `AccessKey Secret`.

2. Перейдите в свойства бакета, чтобы найти `Bucket Name` (имя бакета) и `Region` (регион).

![Детали бакета](https://static-docs.nocobase.com/file-storage-s3-pro-1735355971345.png)

#### Публичный доступ (опционально)

Для публичного доступа к файлам настройте следующее:

1. В панели разрешений перейдите к «Object Ownership» (Владение объектами), нажмите «Edit» (Изменить) и включите ACL.

![Включить ACL](https://static-docs.nocobase.com/file-storage-s3-pro-1735355971508.png)

2. Прокрутите до «Block public access» (Блокировка публичного доступа), нажмите «Edit» и разрешите управление через ACL.

![Блокировка публичного доступа](https://static-docs.nocobase.com/file-storage-s3-pro-1735355971668.png)

3. В настройках NocoBase отметьте опцию «Public access» (Публичный доступ).

#### Настройка миниатюр (опционально)

Эта настройка необязательна и используется, если требуется оптимизировать размер или качество изображений при предварительном просмотре. **Обратите внимание: развертывание может повлечь дополнительные расходы. Подробности см. в условиях и тарифах AWS.**

1. Перейдите на страницу [Dynamic Image Transformation for Amazon CloudFront](https://aws.amazon.com/solutions/implementations/dynamic-image-transformation-for-amazon-cloudfront/?nc1=h_ls).

2. Нажмите кнопку `Launch in the AWS Console` внизу страницы, чтобы начать развертывание.
   ![](https://static-docs.nocobase.com/20250221164214117.png)

3. Следуйте инструкциям для завершения настройки. Обратите внимание на следующие параметры:
   1. При создании стека укажите имя бакета Amazon S3, в котором хранятся исходные изображения. Введите имя созданного ранее бакета.
   2. Если выбрано развертывание демо-интерфейса, после завершения вы сможете протестировать обработку изображений. В консоли AWS CloudFormation выберите свой стек, перейдите на вкладку «Outputs» (Выходные данные), найдите значение ключа `DemoUrl` и перейдите по ссылке, чтобы открыть демо-интерфейс.
   3. Решение использует библиотеку `sharp` для Node.js для эффективной обработки изображений. Исходный код доступен на GitHub и может быть адаптирован под ваши нужды.

   ![](https://static-docs.nocobase.com/20250221164315472.png)
   ![](https://static-docs.nocobase.com/20250221164404755.png)

4. После завершения настройки дождитесь, пока статус развертывания изменится на `CREATE_COMPLETE`.

5. В настройках NocoBase учтите следующее:
   1. `Правило для миниатюр`: укажите параметры обработки изображений, например `?width=100`. Подробности см. в [документации AWS](https://docs.aws.amazon.com/solutions/latest/serverless-image-handler/use-supported-query-param-edits.html).
   2. `Базовый URL доступа`: введите значение из Outputs → ApiEndpoint после развертывания.
   3. `Полный стиль URL-доступа`: выберите **Ignore** (так как имя бакета уже указано в настройках, дополнительные действия не требуются).

   ![](https://static-docs.nocobase.com/20250414152135514.png)

#### Пример настройки

![](https://static-docs.nocobase.com/20250414152344959.png)

#### Настройка CORS

1. Перейдите на страницу сведений о бакете.

![Страница сведений о бакете](https://static-docs.nocobase.com/file-storage-s3-pro-1735355973018.png)

2. В меню выберите «Безопасность контента → CORS».

![Меню CORS](https://static-docs.nocobase.com/file-storage-s3-pro-1735355973319.png)

3. Нажмите «Создать правило», заполните поля и нажмите «ОК».

![Настройка правила CORS](https://static-docs.nocobase.com/20250219171042784.png)

#### Получение AccessKey и SecretAccessKey

1. Нажмите «AccessKey» под аватаром вашего аккаунта.

![Меню AccessKey](https://static-docs.nocobase.com/file-storage-s3-pro-1735355973884.png)

2. Создайте AccessKey. Для рабочих сред рекомендуется ознакомиться с [Руководством по RAM AccessKey](https://help.aliyun.com/zh/ram/user-guide/create-an-accesskey-pair-1?spm=5176.28366559.0.0.1b5c3c2fUI9Ql8#section-rjh-18m-7kp).

![Создать AccessKey](https://static-docs.nocobase.com/file-storage-s3-pro-1735355974171.png)

3. Пройдите проверку учётной записи.

![Проверка учётной записи](https://static-docs.nocobase.com/file-storage-s3-pro-1735355974509.png)

4. Сохраните Access Key и Secret Access Key.

![Данные AccessKey](https://static-docs.nocobase.com/file-storage-s3-pro-1735355974781.png)

#### Получение параметров и настройка

1. Используйте полученные `AccessKey ID` и `AccessKey Secret`.

2. Перейдите в сведения о бакете, чтобы получить `Bucket Name` (имя бакета).

![Имя бакета](https://static-docs.nocobase.com/file-storage-s3-pro-1735355975063.png)

3. Прокрутите вниз, чтобы найти `Region` (регион), исключив `.aliyuncs.com`.

![Сведения о регионе](https://static-docs.nocobase.com/file-storage-s3-pro-1735355975437.png)

4. Получите `Endpoint` и добавьте префикс `https://`.

![Настройка Endpoint](https://static-docs.nocobase.com/file-storage-s3-pro-1735355975715.png)

#### Настройка миниатюр (опционально)

Эта настройка необязательна и применяется только при необходимости оптимизации размера или качества изображений в предварительном просмотре.

1. Заполните соответствующие параметры в поле `Правило для миниатюр`. Подробнее о параметрах см. в разделе [Параметры обработки изображений](https://help.aliyun.com/zh/oss/user-guide/img-parameters/?spm=a2c4g.11186623.help-menu-31815.d_4_14_1_1.170243033CdbSm&scm=20140722.H_144582._.OR_help-T_cn~zh-V_1).

2. Убедитесь, что настройки `Полный стиль URL загрузки` и `Полный стиль URL доступа` одинаковы.

#### Пример настройки

![](https://static-docs.nocobase.com/20250414152525600.png)

### MinIO

#### Создание бакета

1. Нажмите на меню **Buckets** слева → Нажмите **Create Bucket**, чтобы открыть страницу создания.

2. Введите имя бакета, затем нажмите кнопку **Save** (Сохранить).

![Создание бакета](https://static-docs.nocobase.com/20250106111325326.png)

#### Получение AccessKey и SecretAccessKey

1. Перейдите в раздел **Access Keys** → Нажмите кнопку **Create access key**, чтобы открыть страницу создания.

![Создать ключ доступа](https://static-docs.nocobase.com/20250106111922957.png)

2. Нажмите кнопку **Save** (Сохранить).

![Сохранить ключ доступа](https://static-docs.nocobase.com/20250106111850639.png)

3. Сохраните **Access Key** и **Secret Key** из всплывающего окна для дальнейшей настройки.

![Данные ключа доступа](https://static-docs.nocobase.com/20250106112831483.png)

#### Настройка параметров

1. Перейдите на страницу **Менеджер файлов** в NocoBase.

2. Нажмите кнопку **Добавить новое** и выберите **S3 Pro**.

3. Заполните форму следующим образом:
   - **AccessKey ID** и **AccessKey Secret**: используйте значения, сохранённые на предыдущем шаге.
   - **Region** (Регион): для локальных развертываний MinIO понятие региона не применяется. Установите значение `"auto"`.
   - **Endpoint**: введите доменное имя или IP-адрес вашего развернутого сервиса.
   - Установите параметр **Force path style** (Принудительный стиль пути) в значение **Path-Style**. Итоговый URL файла будет иметь вид:  
     `https://{Endpoint}/{bucket-name}/{fileKey}`.

#### Пример настройки

![](https://static-docs.nocobase.com/20250414152700671.png)

### Tencent COS

См. предыдущие настройки. Процесс аналогичен.

#### Пример настройки

![](https://static-docs.nocobase.com/20250414153252872.png)

### Cloudflare R2

См. предыдущие настройки. Процесс аналогичен.

#### Пример настройки

![](https://static-docs.nocobase.com/20250414154500264.png)

## Руководство пользователя

См. документацию по плагину [file-manager](https://docs.nocobase.com/handbook/file-manager/)
