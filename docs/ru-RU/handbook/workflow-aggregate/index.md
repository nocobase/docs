# Агрегация

<PluginInfo name="workflow-aggregate" link="/handbook/workflow-aggregate"></PluginInfo>

Этот плагин предназначен для выполнения агрегатных запросов к данным в таблицах, соответствующих заданным условиям, с возвратом статистических результатов. Особенно полезен для формирования отчетных данных.

Узел использует агрегатные функции базы данных и в текущей версии поддерживает запросы к одному полю в одной таблице данных. Полученная статистика сохраняется в выходных данных узла и становится доступной для последующих узлов workflow.

## Установка

Это встроенный плагин, не требующий дополнительной установки.

## Руководство пользователя

### Создание узла

В интерфейсе настройки workflow нажмите "+" в процессе, чтобы добавить узел "Агрегатный запрос":

![Создание узла агрегации](https://static-docs.nocobase.com/7f9d806ebf5064f80c30f8b67f316f0f.png)

### Настройка узла

![Настройка узла агрегации](https://static-docs.nocobase.com/57362f747b9992230567c6bb5e986fd2.png)

#### Агрегатные функции

Поддерживаются пять SQL-функций: `COUNT`, `SUM`, `AVG`, `MIN` и `MAX`. Выберите нужную функцию для выполнения запроса.

#### Тип цели

Два способа выбора цели запроса:
1. Прямой выбор таблицы и поля
2. Выбор связанной таблицы и поля из контекста workflow

#### Уникальные значения

Соответствует ключевому слову `DISTINCT` в SQL. Поле для уникальности должно совпадать с выбранным полем таблицы.

#### Условия фильтрации

Применяются аналогично стандартным запросам таблицы с использованием переменных workflow.

### Пример

Рассмотрим пример подсчета общего количества статей в категории после добавления новой статьи.

Создадим две таблицы:
1. "Статьи" (связь многие-к-одному с "Категориями")
2. "Категории" (связь один-ко-многим со "Статьями")

Настроим workflow, срабатывающий при добавлении новой статьи, с узлом агрегации:

![Пример настройки](https://static-docs.nocobase.com/542272e638c6c0a567373d1b37ddda78.png)

Узел будет подсчитывать количество статей в категории новой статьи и сохранять результат.

:::info{title=Совет}
Для доступа к связанным данным в триггере таблицы настройте "Предзагрузку ассоциаций", иначе поля будут недоступны.
:::
