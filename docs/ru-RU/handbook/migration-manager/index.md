# Менеджер миграций

<PluginInfo licenseBundled="true" name="migration-manager"></PluginInfo>

## Введение

Менеджер миграций помогает переносить конфигурации приложений из одного окружения в другое. Его основная задача — миграция «конфигураций приложений». Если вам требуется полный перенос данных, рекомендуем использовать «[Менеджер резервного копирования](/handbook/backups)» для создания резервных копий и восстановления всего приложения.

## Установка

Менеджер миграций зависит от [Менеджера резервного копирования](/handbook/backups). Убедитесь, что плагин Менеджера резервного копирования уже установлен и активирован. Подробнее см. в разделе [Установка и обновление коммерческих плагинов](/welcome/getting-started/plugin).

## Процесс и принципы работы

Менеджер миграций переносит таблицы и данные из основной базы данных на основе указанных правил миграции, перемещая их из одного экземпляра приложения в другой. Обратите внимание, что он не переносит данные из внешних баз данных или подприложений.

![20250102202546](https://static-docs.nocobase.com/20250102202546.png)

## Правила миграции

### Встроенные правила

Менеджер миграций может переносить все таблицы в основной базе данных и поддерживает пять встроенных правил:

1. **Только схема**  
   Переносит только структуру (схему) таблиц — данные не вставляются и не обновляются.

2. **Перезапись (очистка и повторная вставка)**  
   Удаляет все существующие записи из целевой таблицы базы данных, затем вставляет новые данные.

3. **Обновление или вставка (Upsert)**  
   Проверяет, существует ли запись (по первичному ключу). Если существует — обновляет её, если нет — вставляет новую.

4. **Вставка без обновления (Insert-ignore)**  
   Вставляет новые записи, но если запись уже существует (по первичному ключу), вставка игнорируется (обновления не происходит).

5. **Пропуск**  
   Пропускает обработку таблицы полностью (без изменений структуры или переноса данных).

**Дополнительные примечания:**

- «Перезапись», «Обновление или вставка» и «Вставка без обновления» также синхронизируют изменения структуры таблиц.
- Если таблица использует автоинкрементный ID в качестве первичного ключа или не имеет первичного ключа, правила «Обновление или вставка» и «Вставка без обновления» не могут быть применены.
- «Обновление или вставка» и «Вставка без обновления» используют первичный ключ для определения существования записи.

### Подробная схема работы

![20250102204909](https://static-docs.nocobase.com/20250102204909.png)

### Интерфейс настройки

Вы можете настроить правила миграции в интерфейсе:

![20250102205450](https://static-docs.nocobase.com/20250102205450.png)

Включение независимых правил:

![20250107105005](https://static-docs.nocobase.com/20250107105005.png)

Выбор таблиц, к которым применяются эти правила:

![20250107104644](https://static-docs.nocobase.com/20250107104644.png)

## Файлы миграции

![20250102205844](https://static-docs.nocobase.com/20250102205844.png)

### Создание новой миграции

![20250102205857](https://static-docs.nocobase.com/20250102205857.png)

### Выполнение миграции

![20250102205915](https://static-docs.nocobase.com/20250102205915.png)

Во время выполнения система проверяет переменные окружения (подробнее о [Переменных окружения](/handbook/environment-variables)):

![20250102212311](https://static-docs.nocobase.com/20250102212311.png)

Если какие-либо обязательные переменные окружения отсутствуют, появится запрос на их добавление перед продолжением:

![20250102210009](https://static-docs.nocobase.com/20250102210009.png)

## Логи миграции

![20250102205738](https://static-docs.nocobase.com/20250102205738.png)

## Откат

Перед выполнением любой миграции автоматически создаётся резервная копия текущего приложения. Если миграция завершится неудачно или результаты окажутся неожиданными, вы можете выполнить откат с помощью [Менеджера резервного копирования](/handbook/backups).

![20250105195029](https://static-docs.nocobase.com/20250105195029.png)
