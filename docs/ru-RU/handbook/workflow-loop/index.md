# Цикл (Loop)

<PluginInfo name="workflow-loop" link="/handbook/workflow-loop"></PluginInfo>

Функционал цикла работает аналогично конструкциям `for`, `while` или `forEach` в языках программирования. Он предназначен для ситуаций, когда необходимо повторять определенные операции заданное количество раз или перебирать набор данных (например, массив). Узел цикла - это ваш основной инструмент для таких задач.

## Установка

Этот плагин предустановлен, поэтому дополнительная настройка не требуется.

## Руководство пользователя

### Создание узла

В интерфейсе конфигурации workflow вы можете добавить узел "Цикл", нажав на знак плюс ("+") в процессе:

![Создание узла цикла](https://static-docs.nocobase.com/b3c8061a66bfff037f4b9509ab0aad75.png)

После создания узла цикла генерируется внутренняя ветка, специфичная для цикла. Вы можете заполнить эту ветку любым количеством узлов. Эти узлы будут иметь доступ не только к переменным контекста workflow, но и к локальным переменным, определенным в контексте цикла - таким как текущий объект данных или индекс итерации (который начинается с `0`). Эти локальные переменные ограничены исключительно циклом. Для вложенных циклов вы можете использовать переменные, специфичные для каждого уровня цикла.

### Конфигурация узла

![Конфигурация узла цикла](https://static-docs.nocobase.com/20241016135326.png)

#### Объект цикла

Узел цикла может обрабатывать различные типы данных для объекта цикла, каждый по-разному:

1. **Массив**: Это наиболее распространенный случай использования. Обычно вы выбираете переменную контекста workflow, такую как результаты из узла запроса или предзагруженные данные из отношения многие-ко-многим. Если выбран массив, узел цикла будет перебирать каждый элемент, присваивая текущий элемент локальной переменной в контексте цикла для каждой итерации.

2. **Число**: Когда объект цикла - число, оно рассматривается как количество итераций. Индекс в локальной переменной будет соответствовать значению объекта цикла.

3. **Строка**: Если объект цикла - строка, цикл будет выполняться в соответствии с длиной строки, обрабатывая каждый символ по его индексу.

4. **Другие**: Другие типы данных (включая объекты) рассматриваются как единый объект цикла, что приводит только к одной итерации - обычно не требующей цикла.

Вы также можете вводить константы напрямую при работе с числами и строками. Например, ввод `5` (числовой тип) приведет к выполнению цикла 5 раз, а ввод `abc` (тип строки) приведет к 3 итерациям, обрабатывая `a`, `b` и `c` по отдельности. Инструмент выбора переменных позволяет выбрать тип константы, который вы хотите использовать.

#### Условие цикла

Начиная с версии `v1.4.0-beta`, добавлены параметры условия цикла, которые можно включить в конфигурации узла.

**Условие**

Аналогично конфигурации в узле условия, можно настроить комбинацию условий, а также использовать переменные из текущего цикла, такие как элемент цикла и индекс цикла.

**Контрольная точка**

Аналогично `while` и `do/while` в языках программирования, условия можно настроить для оценки либо перед каждой итерацией цикла, либо после ее завершения. Оценка после условия может выполнить другие узлы в теле цикла перед выполнением проверки условия.

**Когда условие не выполняется**

Аналогично операторам `break` и `continue` в языках программирования, можно использовать для определения, следует ли прервать или продолжить цикл.

#### Обработка ошибок внутренних узлов в цикле

Начиная с версии `v1.4.0-beta`, когда внутренний узел в цикле не выполняется (из-за невыполненных условий, ошибок и т.д.), следующий шаг можно определить через эту конфигурацию. Поддерживаются три метода обработки:

* Выход из процесса (по умолчанию)
* Выход из цикла и продолжение процесса
* Переход к следующему элементу цикла

Вы можете выбрать подходящий метод по мере необходимости.

### Пример

Рассмотрим следующий сценарий: при размещении заказа необходимо проверить наличие каждого товара в заказе. Если товар есть в наличии, его количество вычитается; в противном случае товар в деталях заказа помечается как недействительный.

1. Создайте три коллекции: Товар <-(1:m)-- Детали заказа --(m:1)-> Заказ, со следующей моделью данных:

| Название поля     | Тип поля        |
| -------------- | ----------------- |
| Детали заказа | Многие-к-одному (Детали) |
| Общая цена | Число            |

| Название поля | Тип поля        |
| ---------- | ----------------- |
| Товар    | Один-ко-многим (Товар) |
| Количество   | Число            |

| Название поля  | Тип поля  |
| ----------- | ----------- |
| Название товара | Однострочный текст |
| Цена       | Число      |
| Наличие   | Целое число     |

2. Создайте workflow, выбрав "Событие коллекции" в качестве триггера, и выберите таблицу "Заказ" с "Создать запись" в качестве триггера. Кроме того, предварительно загрузите данные отношений из таблицы "Детали заказа" и таблицы Товаров под деталями:

![Пример конфигурации триггера узла цикла](https://static-docs.nocobase.com/0086601c2fc0e17a64d046a4c86b49b7.png)

3. Создайте узел цикла, выбрав объект цикла как "Данные триггера / Детали заказа", который перебирает каждую запись в таблице деталей заказа:

![Пример конфигурации узла цикла](https://static-docs.nocobase.com/2507becc32db5a9a0641c198605a20da.png)

4. Внутри узла цикла создайте узел "Условие" для проверки наличия товара:

![Пример конфигурации узла условия](https://static-docs.nocobase.com/a6d08d15786841e1a3512b38e4629852.png)

5. Если товар есть в наличии, создайте узел "Вычисление" и узел "Обновить запись" под веткой "Да" для обновления количества после вычитания:

![Пример конфигурации узла вычисления](https://static-docs.nocobase.com/8df3604c71f8f8705b1552d3ebfe3b50.png)

![Пример конфигурации узла обновления наличия](https://static-docs.nocobase.com/2d84baa9b3b01bd85fccda9eec992378.png)

6. Если товара нет в наличии, создайте узел "Обновить запись" под веткой "Нет" для обновления статуса детали заказа на "Недействительно":

![Пример конфигурации узла обновления деталей заказа](https://static-docs.nocobase.com/4996613090c254c69a1d80f3b3a7fae2.png)

Полная структура процесса показана ниже:

![Пример структуры процесса узла цикла](https://static-docs.nocobase.com/6f59ef246c1f19976344a7624c4c4151.png)

После настройки и активации этого workflow, каждый раз при создании нового заказа система будет автоматически проверять наличие каждого товара в заказе. Если товар есть в наличии, его количество будет вычтено; в противном случае товар в деталях заказа будет помечен как недействительный (помогая рассчитать действительную общую цену заказа).
