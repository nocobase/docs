# JavaScript

<PluginInfo name="workflow-script" link="/handbook/workflow-script" commercial="true"></PluginInfo>

Узел JavaScript позволяет пользователям выполнять пользовательские скрипты Node.js в "workflow". Эти скрипты могут использовать переменные "workflow" в качестве параметров и возвращать значения, которые могут использовать последующие узлы.

Скрипт поддерживает большинство функций Node.js, но имеет некоторые отличия от собственной среды выполнения. Подробности см. в [Списке функций](#feature-list).

## Руководство пользователя

### Создание узла

В интерфейсе конфигурации "workflow" нажмите кнопку «плюс» («+») в "workflow", чтобы добавить узел «Скрипт»:

![20241007122632](https://static-docs.nocobase.com/20241007122632.png)

### Конфигурация узла

![20241007122825](https://static-docs.nocobase.com/20241007122825.png)

#### Параметры

Используйте параметры для передачи переменных или статических значений из контекста "workflow" в сценарий, делая их доступными в логике сценария. `name` представляет имя параметра, которое будет служить именем переменной в сценарии. `value` представляет значение параметра, которое может быть переменной "workflow" или константой.

#### Содержимое скрипта

Содержимое скрипта функционирует как одна функция, в которой вы можете написать любой код JavaScript, поддерживаемый средой Node.js. Используйте оператор `return`, чтобы предоставить значение в качестве выходных данных узла, сделав его доступным в качестве переменной для нижестоящих узлов.

После написания скрипта используйте кнопку теста под редактором, чтобы открыть диалоговое окно выполнения теста. Заполните параметры статическими значениями для моделирования. В диалоговом окне отображаются возвращаемое значение и выходные данные (журналы) после выполнения.

![20241007153631](https://static-docs.nocobase.com/20241007153631.png)

#### Настройка тайм-аута

Установите тайм-аут в миллисекундах. Значение `0` означает отсутствие тайм-аута.

#### Продолжить рабочий процесс при ошибке

Если включено, "workflow" будет продолжен, даже если скрипт обнаружит ошибку или тайм-аут.

:::info{title="Примечание"}
Когда скрипт завершается неудачей, он не возвращает значение, а вывод узла будет содержать сообщение об ошибке. Если последующие узлы используют переменную результата из этого узла скрипта, обращайтесь с этим осторожно.
:::

## Список функций

### Версия Node.js

Версия Node.js совпадает с версией, используемой основным приложением.

### Поддержка модулей

Скрипт позволяет ограниченно использовать модули, придерживаясь стандарта CommonJS. Используйте директиву `require()` для импорта модулей в ваш код.

Он поддерживает собственные модули Node.js и модули, установленные в `node_modules` (включая зависимости, используемые NocoBase). Чтобы сделать модули доступными в коде, объявите их в переменной среды приложения `WORKFLOW_SCRIPT_MODULES`. Разделяйте несколько имен модулей запятыми, например:

```ini
WORKFLOW_SCRIPT_MODULES=crypto,timers,lodash,dayjs
```

:::info{title="Примечание"}
Модули, не объявленные в `WORKFLOW_SCRIPT_MODULES`, включая собственные модули Node.js или установленные `node_modules`, **не могут** использоваться в скриптах. Эта стратегия позволяет администраторам контролировать модули, доступные пользователям, что снижает риск чрезмерных разрешений скрипта.
:::

### Глобальные переменные

Глобальные переменные, такие как `global`, `process`, `__dirname` и `__filename` **не поддерживаются**.

```js
console.log(global); // выдаст ошибку: "global is not defined"
```

### Входные параметры

Параметры, настроенные в узле, обрабатываются в скрипте как глобальные переменные и могут использоваться напрямую. Поддерживаются только базовые типы, такие как `boolean`, `number`, `string`, `object` и массивы. Объекты `Date` при передаче преобразуются в строки в формате ISO.
Другие сложные типы, такие как экземпляры пользовательских классов, не могут быть переданы напрямую.

### Возвращаемые значения

Используйте оператор `return` для возврата данных базовых типов (таких же, как правила параметров) в узел в качестве его выходных данных. Если код не содержит оператора `return`, узел не будет иметь выходного значения.

```js
return 123;
```

### Вывод (журналы)

**Поддерживает** ведение журнала через `console`.

```js
console.log('hello world!');
```

Вывод узла скрипта также будет записан в соответствующие файлы журнала "workflow".

### Асинхронные операции

**Поддерживает** асинхронные функции с использованием `async` и `await`. Также **поддерживает** глобальный объект `Promise`.

```js
async function test() {
return Promise.resolve(1);
}

const value = await test();
return value;
```

### Таймеры

Чтобы использовать такие методы, как `setTimeout`, `setInterval` или `setImmediate`, импортируйте их из пакета `timers` Node.js.

```js
const { setTimeout, setInterval, setImmediate, clearTimeout, clearInterval, clearImmediate } = require('timers');

асинхронная функция sleep(time) {
return new Promise((resolve) => setTimeout(resolve, time));
}

await sleep(1000);

return 123;
```
