# Агрегация (Aggregate)

<PluginInfo name="workflow-aggregate" link="/handbook/workflow-aggregate"></PluginInfo>

## Обзор

Этот плагин предназначен для выполнения агрегатных запросов к данным в таблицах, соответствующих заданным условиям, с возвратом статистических результатов. Особенно полезен для генерации статистических данных для отчётов.

Узел работает с использованием агрегатных функций базы данных и в текущей версии поддерживает запросы к одному полю в одной таблице данных. Полученная статистика сохраняется в выходных данных узла и становится доступной для последующих узлов рабочего процесса.

## Установка

Это встроенный плагин, не требующий дополнительной установки.

## Руководство пользователя

### Создание узла

В интерфейсе конфигурации workflow нажмите кнопку "+" в потоке процесса, чтобы добавить узел "Агрегатный запрос":

![Создание узла агрегатного запроса](https://static-docs.nocobase.com/7f9d806ebf5064f80c30f8b67f316f0f.png)

### Настройка узла

![Конфигурация узла агрегатного запроса](https://static-docs.nocobase.com/57362f747b9992230567c6bb5e986fd2.png)

#### Агрегатные функции

Поддерживаются пять SQL-функций:
- `COUNT` - подсчёт записей
- `SUM` - сумма значений
- `AVG` - среднее значение
- `MIN` - минимальное значение
- `MAX` - максимальное значение

#### Тип цели

Два метода выбора цели запроса:
1. Прямой выбор таблицы и поля
2. Выбор связанной таблицы из контекста workflow

#### DISTINCT

Соответствует ключевому слову `DISTINCT` в SQL. Поле для DISTINCT должно совпадать с выбранным полем таблицы.

#### Условия фильтрации

Применяются стандартные условия фильтрации, аналогичные запросам к таблицам, с использованием переменных контекста workflow.

### Пример

Рассмотрим пример "подсчёта общего количества статей в категории после добавления новой статьи".

Создадим две таблицы:
1. "Статьи" (с полем "Категория" - связь многие-к-одному)
2. "Категории" (с обратной связью одна-ко-многим)

Настроим workflow, срабатывающий при добавлении новой статьи, с узлом агрегации:

![Пример конфигурации](https://static-docs.nocobase.com/542272e638c6c0a567373d1b37ddda78.png)

После срабатывания узел подсчитает общее количество статей в категории новой статьи.

Для доступа к связанным данным в триггере события таблицы необходимо настроить "Предзагрузку ассоциаций", иначе эти поля будут недоступны для выбора.
