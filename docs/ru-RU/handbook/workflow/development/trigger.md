# **Расширение типов триггеров**

Каждый рабочий процесс должен быть настроен с определённым триггером, который служит точкой входа для выполнения процесса.

Типы триггеров обычно соответствуют определённым событиям в системе. На протяжении жизненного цикла приложения любое событие, которое можно подписаться, может быть определено как тип триггера. Примеры включают получение запросов, операции с таблицами данных или запланированные задачи.

Типы триггеров регистрируются в реестре триггеров плагина с использованием уникальных строковых идентификаторов. Плагин рабочих процессов включает несколько встроенных триггеров:

- `'collection'`: Активируется операциями с таблицами данных.
- `'schedule'`: Активируется запланированными задачами.
- `'action'`: Активируется событиями после выполнения операций.

При расширении типов триггеров важно убедиться, что каждый идентификатор уникален. Серверная часть должна обрабатывать регистрацию подписки и отписки от триггеров, а клиентская часть должна предоставлять соответствующий интерфейс для настройки.

## **Реализация на стороне сервера**

Любой пользовательский триггер должен наследоваться от базового класса `Trigger` и реализовывать методы `on` и `off`, которые управляют подпиской и отпиской от определённых событий системы. Метод `on` должен вызывать `this.workflow.trigger()` внутри колбэка события, чтобы активировать рабочий процесс. Метод `off` должен обеспечивать корректную очистку при отписке.

Свойство `this.workflow` ссылается на экземпляр плагина рабочих процессов, который передаётся в базовый класс `Trigger` при создании.

```ts
import { Trigger } from '@nocobase/plugin-workflow';

class MyTrigger extends Trigger {
  timer: NodeJS.Timeout;

  on(workflow) {
    // Регистрация события
    this.timer = setInterval(() => {
      // Активация рабочего процесса
      this.workflow.trigger(workflow, { date: new Date() });
    }, workflow.config.interval ?? 60000);
  }

  off(workflow) {
    // Отмена регистрации события
    clearInterval(this.timer);
  }
}
```

Затем зарегистрируйте экземпляр триггера в движке рабочих процессов в плагине, который расширяет функциональность:

```ts
import WorkflowPlugin from '@nocobase/plugin-workflow';

export default class MyPlugin extends Plugin {
  load() {
    // Получение экземпляра плагина рабочих процессов
    const workflowPlugin = this.app.pm.get(WorkflowPlugin) as WorkflowPlugin;

    // Регистрация триггера
    workflowPlugin.registerTrigger('interval', MyTrigger);
  }
}
```

После запуска сервера триггер типа `'interval'` будет доступен для добавления и выполнения.

## **Настройка на стороне клиента**

На клиентской стороне основная задача — предоставить интерфейс для настройки, адаптированный под конкретные параметры, необходимые для каждого типа триггера. Каждый тип триггера также должен быть зарегистрирован в плагине рабочих процессов.

Например, для настройки интервального триггера, упомянутого выше, определите поле `interval` в интерфейсе формы:

```ts
import { Trigger } from '@nocobase/workflow/client';

class MyTrigger extends Trigger {
  title = 'Триггер по интервалу';
  // Поля конфигурации триггера
  fieldset = {
    interval: {
      type: 'number',
      title: 'Интервал',
      name: 'config.interval',
      'x-decorator': 'FormItem',
      'x-component': 'InputNumber',
      default: 60000,
    },
  };
}
```

Затем зарегистрируйте этот тип триггера в экземпляре плагина рабочих процессов в расширяющем плагине:

```ts
import { Plugin } from '@nocobase/client';
import WorkflowPlugin from '@nocobase/plugin-workflow/client';

import MyTrigger from './MyTrigger';

export default class extends Plugin {
  // При необходимости измените экземпляр приложения здесь
  async load() {
    const workflow = this.app.pm.get(WorkflowPlugin) as WorkflowPlugin;
    workflow.registerTrigger('interval', MyTrigger);
  }
}
```

После регистрации новый тип триггера появится в интерфейсе настройки рабочих процессов.

Совет

Убедитесь, что идентификатор типа триггера, зарегистрированный на стороне клиента, совпадает с идентификатором на стороне сервера, чтобы избежать ошибок.


Для получения дополнительной информации о определении типов триггеров обратитесь к разделу [Справочник API рабочих процессов](./api#pluginregisterTrigger).
