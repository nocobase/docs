# Событие коллекции

Типы триггеров событий коллекции отслеживают события добавления, удаления и обновления записей в коллекции. При выполнении действия с записью коллекции, соответствующего настроенным условиям, будет запущен связанный рабочий процесс. Например: уменьшение запасов товара после добавления нового заказа, ожидание ручной проверки после добавления комментария и т.д.

## Основное использование

Изменения коллекции могут быть нескольких типов:

1. После добавления записи
2. После обновления записи
3. После добавления или обновления записи
4. После удаления записи

![Выбор времени срабатывания](https://static-docs.nocobase.com/81275602742deb71e0c830eb97aa612c.png)

Вы можете выбрать момент срабатывания в соответствии с бизнес-потребностями. При выборе типа изменения, включающего обновление записи, можно также ограничить поля, изменения в которых должны вызывать срабатывание. Если поля не выбраны - триггер сработает при любом изменении.

![Выбор изменяемых полей](https://static-docs.nocobase.com/874a1475f01298b3c00267b2b4674611.png)

Дополнительно можно настроить условия для каждого поля записи. Триггер сработает только при выполнении условий для указанных полей.

![Настройка условий для данных](https://static-docs.nocobase.com/264ae3835dcd75cee0eef7812c11fe0c.png)

После срабатывания события коллекции исходная запись будет добавлена в контекст выполнения как данные триггера для использования последующими узлами. Однако если последующим узлам нужны связанные поля этой записи, необходимо сначала настроить их предварительную загрузку.

## Важные замечания

### Пакетные операции не поддерживаются

События коллекции пока не поддерживают срабатывание при пакетных операциях с данными. Например, при добавлении статьи и нескольких связанных тегов сработает только workflow для добавления статьи.

### Внешние изменения не вызывают срабатывание

Изменения данных, сделанные напрямую в БД (не через интерфейс NocoBase), не активируют события коллекции. Операции через SQL-узлы также считаются прямыми изменениями БД.

### Внешние источники данных

Начиная с версии 0.20, workflow поддерживает внешние источники данных. События коллекции будут срабатывать для внешних источников только если операции выполняются через приложение NocoBase.

## Пример

Рассмотрим сценарий расчета общей суммы заказа и уменьшения запасов после его добавления.

Сначала создаем коллекции "Товары" и "Заказы" со следующей структурой:

**Товары:**
| Поле | Тип |
|------|-----|
| Название | Текст |
| Цена | Число |
| Запасы | Целое число |

**Заказы:**
| Поле | Тип |
|------|-----|
| Номер | Автономер |
| Товар | Многие-к-одному (Товар) |
| Итоговая сумма | Число |

Добавляем тестовые товары:
- iPhone 14 Pro - 7999 руб. (10 шт.)
- iPhone 13 Pro - 5999 руб. (0 шт.)

Создаем workflow на основе события коллекции "Заказы":

![Пример триггера добавления заказа](https://static-docs.nocobase.com/094392a870dddc65aeb20357f62ddc08.png)

Настройки:
- Коллекция: "Заказы"
- Срабатывание: "После добавления данных"
- Условия: нет
- Предзагрузка связей: "Товар"

Затем настраиваем узлы workflow для проверки запасов и обработки заказа:

![Логика обработки заказа](https://static-docs.nocobase.com/7713ea1aaa0f52a0dc3c92aba5e58f05.png)

После активации workflow:
- При заказе iPhone 14 Pro запасы уменьшатся до 9
- При заказе iPhone 13 Pro заказ будет удален из-за отсутствия товара

![Результат выполнения](https://static-docs.nocobase.com/24cbe51e24ba4804b3bd48d99415c54f.png)
