# Планируемое событие

Планируемые задачи — это события, срабатывающие по временным условиям, включающие два режима:

- Пользовательское время: Регулярные триггеры по расписанию, аналогичные cron, на основе системного времени.
- Поле времени коллекции: Срабатывание по значению временного поля в коллекции.

Когда система достигает времени (с точностью до секунд), соответствующего настроенным условиям срабатывания, запускается соответствующий рабочий процесс.

## Основное использование

### Создание планируемого события

При создании рабочего процесса в списке выберите тип "Планируемое событие":

![Создание планируемого события](https://static-docs.nocobase.com/e09b6c9065167875b2ca7de5f5a799a7.png)

### Режим пользовательского времени

Для регулярного режима сначала настройте время начала на любую точку времени (с точностью до секунд). Время начала можно установить как в будущем, так и в прошлом. Если установлено прошедшее время, система проверит соответствие времени на основе настроенного условия повтора. Если условие повтора не настроено, рабочий процесс не сработает при времени начала в прошлом.

Есть два способа настройки правил повтора:

- Интервал времени: Срабатывание через фиксированные промежутки после времени начала, например каждый час, каждые 30 минут и т.д.
- Расширенный режим: Использование cron-правил для настройки срабатывания в фиксированные моменты даты и времени.

После настройки правила повтора можно также настроить условие завершения — по фиксированному моменту времени или по количеству выполнений.

### Режим поля времени коллекции

Использование поля времени коллекции для определения времени начала — это режим триггера, сочетающий обычные планируемые задачи с полем времени коллекции. Этот режим упрощает некоторые узлы в специфических процессах и делает конфигурацию более интуитивной. Например, для изменения статуса неоплаченных заказов старше 30 минут на "отменён" достаточно настроить планируемую задачу в режиме поля времени коллекции, выбрав время начала как "30 минут после поля времени создания заказа".

## Связанные рекомендации

### Планируемые задачи при остановленном приложении

Если настроенные временные условия выполнены, но сервис приложения NocoBase остановлен или выключен, соответствующие планируемые задачи будут пропущены. После перезапуска сервиса пропущенные задачи не выполнятся автоматически. Рекомендуется предусматривать обработку таких ситуаций или резервные механизмы.

### Счётчик повторов

При настройке количества повторов в условии завершения учитывается общее количество выполнений одного рабочего процесса во всех версиях. Например, если задача уже выполнялась 10 раз в версии 1, а максимальное количество повторов равно 10, workflow больше не сработает, даже если его скопировать в новую версию. Однако при дублировании в новый рабочий процесс счётчик выполнений сбрасывается.

### Разница между интервальным временем и расширенным режимом

Интервальное время в правиле повтора отсчитывается от момента предыдущего срабатывания (или времени начала), тогда как расширенный режим срабатывает в фиксированные моменты. Например, при настройке "каждые 30 минут" и последнем срабатывании в 12:01:23 следующее будет в 12:31:23. Расширенный режим работает как cron — срабатывает строго по заданным временным точкам.

## Пример

Допустим, мы хотим каждую минуту проверять заказы, не оплаченные более 30 минут, и автоматически менять их статус на "отменён". Реализуем это обоими способами.

### Режим пользовательского времени

Создаём workflow на основе планируемой задачи, выбираем режим "Пользовательское время", устанавливаем время начала не позднее текущего момента, настраиваем повтор "каждую минуту" без условия завершения:

![Настройка триггера - пользовательское время](https://static-docs.nocobase.com/71131e3f2034263f883062389b356cbd.png)

Затем настраиваем другие узлы workflow для вычисления времени "30 минут назад" и обновления статуса неоплаченных заказов, созданных до этого времени:

![Логика обработки](https://static-docs.nocobase.com/188bc5287ffa1fb24a4e7baa1de6eb29.png)

После активации workflow будет срабатывать каждую минуту, вычислять временную границу и обновлять статусы.

### Режим поля времени коллекции

Создаём workflow, выбираем режим "Поле времени коллекции", указываем коллекцию "Заказы", устанавливаем время начала как "30 минут после создания заказа", выбираем "без повтора":

![Настройка триггера - поле коллекции](https://static-docs.nocobase.com/d40d5aef57f42799d31cc5882dd94246.png)

Затем настраиваем узел обновления для изменения статуса конкретного заказа (ID берётся из контекста срабатывания):

![Узел обновления](https://static-docs.nocobase.com/491dde9df8f773f5b14a4fd8ceac9d3e.png)

В отличие от первого способа, здесь не требуется вычислять временную границу — workflow срабатывает уже для конкретных записей, соответствующих условию по времени.
