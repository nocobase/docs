# JSON-вычисления

<PluginInfo name="workflow-json-query" link="/handbook/workflow-json-query" commercial="true"></PluginInfo>

Этот плагин предназначен для преобразования и вычисления сложных JSON-данных, генерируемых различными узлами, что позволяет последующим узлам эффективно использовать эти данные. Например, SQL-операции и узлы HTTP-запросов часто возвращают результаты в формате JSON. Узел JSON-вычислений позволяет преобразовать эти данные в конкретные значения и форматы переменных, необходимые для последующих этапов workflow.

## Руководство пользователя

### Создание узла

Чтобы добавить узел "JSON-вычисления" в интерфейсе конфигурации workflow, просто нажмите кнопку плюс ("+") в процессе:

![Создание узла](https://static-docs.nocobase.com/7de796517539ad9dfc88b7160f1d0dd7.png)

:::info{title=Совет}
Узлы JSON-вычислений обычно размещаются под другими узлами данных для удобства анализа их вывода.
:::

### Конфигурация узла

#### Движок парсинга

Узел JSON-вычислений поддерживает различные движки парсинга, каждый со своим уникальным синтаксисом. Вы можете выбрать движок в зависимости от ваших потребностей. В настоящее время доступны три движка:

- [JMESPath](https://jmespath.org/)
- [JSONPath Plus](https://jsonpath-plus.github.io/JSONPath/docs/ts/)
- [JSONata](https://jsonata.org/)

![Выбор движка парсинга](https://static-docs.nocobase.com/29be3b92a62b7d20312d1673e749f2ec.png)

#### Источник данных

Источником данных может быть либо вывод вышестоящего узла, либо объект данных в контексте процесса. Обычно это неструктурированный объект данных, например, результаты SQL-узла или узла HTTP-запроса.

![Источник данных](https://static-docs.nocobase.com/f5a97e20693b3d30b3a994a576aa282d.png)

:::info{title=Совет}
Объекты данных, связанные с таблицами данных, обычно уже структурированы через информацию о конфигурации таблицы и, как правило, не требуют парсинга узлом JSON-вычислений.
:::

#### Выражение парсинга

Вы можете создать собственное выражение парсинга в соответствии с вашими потребностями и выбранным движком.

![Выражение парсинга](https://static-docs.nocobase.com/181abd162fd32c09b62f6aa1d1cb3ed4.png)

:::info{title=Совет}
Разные движки парсинга используют разный синтаксис; обратитесь к документации по ссылкам для получения подробной информации.
:::

Начиная с версии `v1.0.0-alpha.15`, выражения поддерживают использование переменных. Эти переменные предварительно обрабатываются перед выполнением конкретного движка, заменяясь соответствующими строковыми значениями согласно правилам строковых шаблонов и объединяясь с другими статическими элементами выражения. Эта функция особенно полезна при динамическом построении выражений, например, при парсинге JSON-содержимого, требующего динамических ключей.

#### Сопоставление свойств

Когда результат парсинга представляет собой объект (или массив объектов), вы можете использовать сопоставление свойств для преобразования нужных атрибутов в подпеременные для использования последующими узлами.

![Сопоставление свойств](https://static-docs.nocobase.com/b876abe4ccf6b4709eb8748f21ef3527.png)

:::info{title=Совет}
Для результатов в виде объектов (или массивов объектов), если вы не выполняете сопоставление свойств, весь объект (или массив объектов) будет сохранен как одна переменная в результате узла, что делает невозможным прямой доступ к значениям атрибутов объекта как к отдельным переменным.
:::

### Пример

Предположим, вам нужно проанализировать данные из SQL-узла, который возвращает набор данных о заказах:

```json
[
  [
    {
      "id": 1,
      "products": [
        {
          "id": 1,
          "title": "Product 1",
          "price": 100,
          "quantity": 1
        },
        {
          "id": 2,
          "title": "Product 2",
          "price": 120,
          "quantity": 2
        }
      ]
    },
    {
      "id": 2,
      "products": [
        {
          "id": 3,
          "title": "Product 3",
          "price": 130,
          "quantity": 1
        },
        {
          "id": 4,
          "title": "Product 4",
          "price": 140,
          "quantity": 2
        }
      ]
    }
  ]
]
```

:::info{title=Совет}
Внешний массив в коде выше не случаен; он отражает типичный вывод SQL-узла. Это связано с тем, что результат SQL-узла представляет собой бинарный массив, где первый элемент содержит результаты запроса, а второй элемент — метаданные о запросе.
:::

Если вам нужно проанализировать и вычислить общую стоимость для каждого заказа и собрать эти данные в объект с соответствующим ID заказа, готовый для обновления общей стоимости заказа, настройка будет выглядеть следующим образом:

![Пример - Конфигурация парсинга SQL](https://static-docs.nocobase.com/e62322a868b26ff98120bfcd6dcdb3bd.png)

1. Выберите движок парсинга JSONata;
2. Выберите результат SQL-узла в качестве источника данных;
3. Используйте выражение JSONata `$[0].{"id": id, "total": products.(price * quantity)}` для парсинга;
4. Выберите сопоставление свойств для отображения `id` и `total` как подпеременных;

Конечный результат парсинга будет выглядеть так:

```json
[
  {
    "id": 1,
    "total": 340
  },
  {
    "id": 2,
    "total": 410
  }
]
```

Затем вы можете перебрать массив завершенных заказов, чтобы обновить общую стоимость каждого заказа.

![Обновление общей стоимости соответствующего заказа](https://static-docs.nocobase.com/b3329b0efe4471f5eed1f0673bef740e.png)
