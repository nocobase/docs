# Событие Webhook

<PluginInfo name="workflow-webhook" link="/handbook/workflow-webhook" commercial="true"></PluginInfo>

Триггер вебхука предоставляет системно сгенерированный URL для вызова третьей стороной через HTTP POST запросы. Этот URL запускает выполнение рабочего процесса при наступлении определенных событий, таких как обратные вызовы платежей или уведомления.
## Пользовательское руководство

### Создание триггера

Создайте рабочий процесс, выберите "Webhook Event" в качестве типа рабочего процесса:

![20241210105049](https://static-docs.nocobase.com/20241210105049.png)
[workflow-javascript](../workflow-javascript)
:::info{title="Подсказка"}
Основное различие между "Синхронными" и "Асинхронными" рабочими процессами заключается в их поведении ответа. Синхронные рабочие процессы ожидают завершения выполнения рабочего процесса перед возвратом ответа. В отличие от них, асинхронные рабочие процессы немедленно возвращают предварительно настроенный ответ, а затем выполняют рабочий процесс в фоновом режиме.
:::

### Настройка триггера

![20241210105441](https://static-docs.nocobase.com/20241210105441.png)

#### Webhook URL

URL автоматически генерируется и привязывается к рабочему процессу. Используйте кнопку копирования, чтобы вставить URL в систему третьей стороны. 

HTTP запросы должны использовать метод POST. Другие методы возвращают ошибку`405`. 

#### Безопасность

Поддерживается базовая HTTP аутентификация. Включив эту опцию и установив имя пользователя и пароль, вы можете защитить Webhook. Система третьей стороны должна включать имя пользователя и пароль в URL Webhook для аутентификации  (Criteria Detail: [MDN: HTTP authentication](https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication#basic_authentication_scheme)).

Когда имя пользователя и пароль установлены, система проверяет, соответствуют ли имя пользователя и пароль в запросе, и возвращает ошибку`401`, если совпадение не найдено.

#### Парсинг данных запроса

Данные в HTTP запросах должны быть распарсены, чтобы сделать их доступными для использования в рабочем процессе. Распарсенные данные доступны как переменные в последующих узлах.

Парсинг HTTP запроса делится на три части:  

1. Заголовки запроса

   Заголовки представляют собой простые пары ключ-значение в строковом формате. Укажите нужные вам поля, такие как `Date` , `X-Request-Id`, и т.д.

2. Параметры запроса

Параметры запроса — это параметры URL запроса, например`http://localhost:13000/api/webhook:trigger/1hfmkioou0d? query=1` Вставьте полный URL-пример или только часть параметров запроса и нажмите кнопку парсинга для автоматического парсинга пар ключ-значение.
  
  ! [20241210111155](https://static-docs.nocobase.com/20241210111155.png)

Автоматический парсинг преобразует часть параметров URL в JSON-структуру и создает путь на основе иерархии параметров, например `query[0]`, `query[0].a`, и т.д. Имена путей можно вручную изменить, если они не удовлетворяют требованиям, но обычно это не требуется. Алиасы необязательны для отображения имени переменной при использовании в качестве переменной. Одновременно генерируются все таблицы параметров в примере. Если есть ненужные параметры, их можно удалить.
  
3. Тело запроса

Тело запроса — это тело HTTP запроса. В настоящее время поддерживаются только тела запросов в формате Content-Type application/json. Вы можете напрямую настроить путь для парсинга или ввести пример JSON и нажать кнопку парсинга для автоматического парсинга.

  ! [20241210112529](https://static-docs.nocobase.com/20241210112529.png)

Автоматический парсинг JSON-структуры преобразует пары ключ-значение в пути, например,  `{" a ": 1," b ": {" c" : 2}}` генерирует пути  `a`, `b`, `b.c` и т.д. Алиасы необязательны для отображения имени переменной при использовании в качестве переменной. Одновременно генерируются все таблицы параметров в примере. Если есть ненужные параметры, их можно удалить.

#### Настройка ответа

Часть ответа вебхука настраивается по-разному для синхронных и асинхронных рабочих процессов. В асинхронных рабочих процессах настройка ответа осуществляется непосредственно в триггере. После получения запроса вебхука конфигурация ответа в триггере сразу возвращается системе третьей стороны до выполнения рабочего процесса. В синхронных рабочих процессах ответ нужно обрабатывать в процессе, добавляя узлы ответа по мере необходимости (Detail: [Response nodes](#response nodes)).

Обычно ответ на асинхронно вызванное событие вебхука имеет статус-код `200` и тело ответа `ok`. Вы также можете настроить статус-код, заголовок ответа и тело ответа.

! [20241210114312](https://static-docs.nocobase.com/20241210114312.png)

### Узел ответа

Поддерживается только для использования в синхронном режиме рабочих процессов Webhook для ответов, возвращаемых системам третьей стороны. Например, если во время обработки обратного вызова платежа возникает неожиданный результат (например, ошибка или сбой), узел ответа может вернуть ошибочный ответ системе третьей стороны, чтобы некоторые системы третьей стороны могли повторить попытку позже в зависимости от состояния.

Кроме того, выполнение узла ответа прекращает выполнение рабочего процесса, и последующие узлы не выполняются. Если в рабочем процессе не настроен узел ответа, система автоматически отвечает в зависимости от состояния выполнения процесса, возвращая `200` при успешном выполнении и `500` при неудачном выполнении.

#### Создание узла ответа

В интерфейсе конфигурации рабочего процесса нажмите кнопку плюса ("+") в процессе, чтобы добавить узел "Ответ":

! [20241210115120](https://static-docs.nocobase.com/20241210115120.png)

#### Конфигурация ответа

! [20241210115500](https://static-docs.nocobase.com/20241210115500.png)

В теле ответа можно использовать переменные из контекста рабочего процесса.

#### Пример 

В синхронном режиме рабочего процесса Webhook можно возвращать разные ответы в зависимости от различных условий бизнес-логики, как показано на рисунке ниже:

! [20241210120655](https://static-docs.nocobase.com/20241210120655.png)

Через узел условного ветвления проверяется, удовлетворяет ли состояние службы заданным условиям. Если да, отображается сообщение об успехе. В противном случае, отображается сообщение об ошибке.
