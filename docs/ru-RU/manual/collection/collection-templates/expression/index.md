# Использование таблиц выражений

## Основные понятия

В отличие от полей формул в таблицах данных, которые применяются ко всей таблице единообразно, динамические выражения позволяют выполнять вычисления с разными формулами для каждой строки данных. Вычисления с динамическими выражениями **поддерживаются только в рабочих процессах**.

Таблица выражений предназначена для хранения различных формул для одного типа данных. Обычно она имеет отношение «многие к одному» (belongsTo) с таблицей данных, участвующей в вычислениях:

Отношение «многие к одному» — это типичный случай, но на практике связь между обычной таблицей данных и таблицей выражений может быть установлена произвольно. Сценарий, когда одна строка данных связана с несколькими выражениями, обычно требует дополнительных отличительных полей или используется в циклах для выполнения различных вычислений для одной строки.

Три поля таблицы выражений и их значения:

- **Таблица данных**: эквивалент параметра функции, источник полей-переменных, доступных в выражении. Вычисления могут базироваться только на полях одной таблицы данных.
- **Вычислительный движок**: доступны варианты `mathjs` и `formulajs`, рекомендуется использовать `formulajs`.
- **Выражение**: эквивалент содержимого функции, при выполнении вычисления возвращает результат на основе конфигурации.

## Пример

Рассмотрим пример расчета итоговой цены в процессе заказа товара с учетом различных правил скидок для разных товаров.

1. Создайте таблицу товаров:

| Название поля | Тип                    |
|---------------|------------------------|
| Название товара | Текст                 |
| Цена товара   | Число                 |
| Правило скидки | belongsTo (Таблица правил скидок) |

2. Создайте таблицу правил скидок (с использованием шаблона таблицы выражений):

| Название поля | Тип                     |
|---------------|-------------------------|
| Название правила | Текст                 |
| Таблица данных | Выбор (таблица данных) |
| Вычислительный движок | Выбор (mathjs/formulajs) |
| Выражение     | Текст                 |

3. Создайте правила скидок:

| ID  | Название       | Таблица данных | Вычислительный движок | Выражение              |
|-----|----------------|----------------|-----------------------|------------------------|
| 1   | Скидка 20%     | Товары         | formulajs             | {{Товары.Цена}} * 0.8 |
| 2   | Скидка 10%     | Товары         | formulajs             | {{Товары.Цена}} * 0.9 |

4. Создайте товары и свяжите их с правилами скидок:

| ID  | Название товара | Цена | ID правила скидки |
|-----|-----------------|------|-------------------|
| 1   | iPhone 14 Pro   | 7999 | 2                 |
| 2   | iPhone 13 Pro   | 5999 | 1                 |

5. Создайте рабочий процесс, который запускается при создании заказа:

![Создание рабочего процесса](https://static-docs.nocobase.com/fda005ee028675b7ac5f11784b5fc437.png)

6. Добавьте узел вычисления, настройте динамическое выражение на основе данных триггера/товары/правило скидки:

![Настройка узла вычисления](https://static-docs.nocobase.com/67de28dcda9fc0f662933ea0a6d272d6.png)

Настройте источник переменных данных на товары из данных триггера:

![Настройка источника данных](https://static-docs.nocobase.com/c58eeb07213d7fe6bb6c19b84b187e23.png)

7. Добавьте узел обновления данных, настройте обновление общей стоимости заказа на результат вычисления узла:

![Обновление данных](https://static-docs.nocobase.com/a1200868b89997ed3caa8332b1ebca4f.png)

8. Создайте заказ, запустите рабочий процесс, затем проверьте список заказов и убедитесь в правильности цен:

![Проверка цен](https://static-docs.nocobase.com/6e62f43a46f7959d487c4d581a3af3ce.png)

| Товар заказа  | Оригинальная цена | Правило скидки | Итоговая цена         |
|---------------|-------------------|----------------|-----------------------|
| iPhone 14 Pro | 7999              | Скидка 10%     | 7999 * 0.9 = 7199.1  |
| iPhone 13 Pro | 5999              | Скидка 20%     | 5999 * 0.8 = 4799.2  |
