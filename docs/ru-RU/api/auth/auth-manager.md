# AuthManager

## Обзор

`AuthManager` — это модуль управления аутентификацией пользователей в NocoBase, предназначенный для регистрации различных типов аутентификации.

### Базовое использование

```ts
const authManager = new AuthManager({
  // Ключ для получения идентификатора текущего аутентификатора из заголовка запроса
  authKey: 'X-Authenticator',
});

// Установка методов для хранения и получения аутентификаторов в AuthManager
authManager.setStorer({
  get: async (name: string) => {
    return db.getRepository('authenticators').find({ filter: { name } });
  },
});

// Регистрация типа аутентификации
authManager.registerTypes('basic', {
  auth: BasicAuth,
  title: 'Пароль',
});

// Использование middleware аутентификации
app.resourceManager.use(authManager.middleware());
```

### Основные понятия

- **Тип аутентификации (`AuthType`)**: различные способы аутентификации, например: по паролю, по SMS, OIDC, SAML и т.д.
- **Аутентификатор (Authenticator)**: сущность, хранящаяся в базе данных, связанная с конфигурацией определённого типа аутентификации (`AuthType`). Для одного типа может существовать несколько аутентификаторов, каждый из которых предоставляет отдельную схему аутентификации.
- **Имя аутентификатора**: уникальный идентификатор аутентификатора, используемый для определения того, какая аутентификация применяется в текущем запросе.

## Методы класса

### `constructor()`

Конструктор, создающий экземпляр `AuthManager`.

#### Сигнатура

- `constructor(options: AuthManagerOptions)`

#### Типы

```ts
export interface JwtOptions {
  secret: string;
  expiresIn?: string;
}

export type AuthManagerOptions = {
  authKey: string;
  default?: string;
  jwt?: JwtOptions;
};
```

#### Подробности

##### AuthManagerOptions

| Атрибут   | Тип                        | Описание                                                                 | По умолчанию       |
|----------|----------------------------|--------------------------------------------------------------------------|--------------------|
| `authKey`| `string`                   | Опциональный ключ для хранения идентификатора аутентификатора в заголовке запроса | `X-Authenticator` |
| `default`| `string`                   | Опционально, идентификатор аутентификатора по умолчанию                   | `basic`            |
| `jwt`    | [`JwtOptions`](#jwtoptions)| Опционально, настройка JWT для аутентификации                             | —                  |

##### JwtOptions

| Атрибут     | Тип     | Описание                     | По умолчанию |
|------------|--------|------------------------------|-------------|
| `secret`   | `string` | Секретный ключ токена         | `X-Authenticator` |
| `expiresIn`| `string` | Опционально, срок действия токена | `7d`        |

### `setStorer()`

Устанавливает методы для хранения и получения данных аутентификаторов.

#### Сигнатура

- `setStorer(storer: Storer)`

#### Типы

```ts
export interface Authenticator = {
  authType: string;
  options: Record<string, any>;
  [key: string]: any;
};

export interface Storer {
  get: (name: string) => Promise<Authenticator>;
}
```

#### Подробности

##### Authenticator

| Атрибут    | Тип                  | Описание                          |
|-----------|----------------------|-----------------------------------|
| `authType`| `string`             | Тип аутентификации                |
| `options` | `Record<string, any>`| Конфигурационные параметры аутентификатора |

##### Storer

`Storer` — интерфейс для хранения аутентификаторов, содержит один метод:

- `get(name: string): Promise<Authenticator>` — получение аутентификатора по его идентификатору. В NocoBase фактически возвращаемый тип — это [AuthModel](../../handbook/auth/dev/api#authmodel).

### `registerTypes()`

Регистрирует новый тип аутентификации.

#### Сигнатура

- `registerTypes(authType: string, authConfig: AuthConfig)`

#### Типы

```ts
export type AuthExtend<T extends Auth> = new (config: Config) => T;

type AuthConfig = {
  auth: AuthExtend<Auth>; // Класс аутентификации.
  title?: string; // Отображаемое имя типа аутентификации.
};
```

#### Подробности

| Атрибут | Тип               | Описание                                                          |
|--------|-------------------|-------------------------------------------------------------------|
| `auth` | `AuthExtend<Auth>`| Реализация типа аутентификации, см. [Auth](./auth.md)             |
| `title`| `string`          | Опционально. Название типа аутентификации, отображаемое в интерфейсе |

### `listTypes()`

Возвращает список зарегистрированных типов аутентификации.

#### Сигнатура

- `listTypes(): { name: string; title: string }[]`

#### Подробности

| Атрибут | Тип     | Описание                        |
|--------|--------|---------------------------------|
| `name` | `string`| Идентификатор типа аутентификации|
| `title`| `string`| Название типа аутентификации    |

### `get()`

Получает аутентификатор по имени.

#### Сигнатура

- `get(name: string, ctx: Context)`

#### Подробности

| Атрибут | Тип      | Описание              |
|--------|---------|------------------------|
| `name` | `string`| Идентификатор аутентификатора |
| `ctx`  | `Context`| Контекст запроса       |

### `middleware()`

Middleware аутентификации. Получает текущий аутентификатор и выполняет аутентификацию пользователя.
