# 数据表事件

数据表事件类型的触发器将监听数据表的增删改查事件，当发生对该表的数据操作且满足配置的条件时，触发对应工作流。例如新增订单后扣减商品的库存，新增一条评论后等待人工审核等场景。

## 基本使用

数据表的变动有几种情况：

1. 新增数据后。
2. 更新数据后。
3. 新增或更新数据后。
4. 删除数据后。

<figure>
  <img alt="数据表事件_触发时机选择" src="https://github.com/nocobase/nocobase/assets/525658/413815a7-53ca-4535-9aaf-0633192a3133" width="371">
</figure>

可以根据业务的不同需要选择触发的时机。当选择变动情况中包含更新数据表的情况时，还可以对发生变动的字段进行限定，只有选中字段发生变动时，才满足触发条件，不选择则代表所有字段发生变动都可以触发。

<figure>
  <img alt="数据表事件_发生变动的字段选择" src="https://github.com/nocobase/nocobase/assets/525658/b44537a4-785a-4eef-8dae-8542630518e5" width="671">
</figure>

更细节地，可以对触发的数据行的各个字段配置条件规则，当其中的字段满足相应条件，才进行触发。

<figure>
  <img alt="数据表事件_配置数据满足的条件" src="https://github.com/nocobase/nocobase/assets/525658/7905c8fe-7b98-47bc-be33-2524af32c958" width="676">
</figure>

数据表事件触发后会在执行计划中注入产生事件的数据行作为触发上下文数据，以供后续流程中的节点作为变量调用。但当后续节点中希望使用该数据的关系字段时，需要先配置对关系数据的预加载，选中的关系数据将会在触发后一并注入到上下文中，且可被按层级进行选择使用。

## 相关提示

### 暂不支持批量数据操作触发

数据表事件事件暂不支持批量数据操作的触发，例如新增文章数据时同时新增的该文章的多个标签数据（对多关系数据），将仅能触发对文章新增的工作流，而同时新增的多个标签将不会触发新增标签的工作流。多对多关系数据的关联和新增时，也不会触发中间表的工作流。

### 非应用内的数据操作不会触发

另外，通过 HTTP API 调用应用接口对数据表的操作也可以触发相应事件，但如果不通过 NodoBase 应用，而是直接通过数据库操作产生的数据变动，就无法触发相应事件。比如数据库中本身的触发器不会与应用中的工作流产生关联。

## 示例

以新增一个订单后计算总价并扣减库存的场景举例。

首先，我们创建商品表和订单表，数据模型如下：

| 字段名称 | 字段类型 |
| -------- | -------- |
| 商品名称 | 单行文本 |
| 价格     | 数字     |
| 库存     | 整数     |

| 字段名称 | 字段类型       |
| -------- | -------------- |
| 订单号   | 自动编号       |
| 订单商品 | 多对一（商品） |
| 订单总价 | 数字           |

并添加基础的商品数据：

| 商品名称      | 价格 | 库存 |
| ------------- | ---- | ---- |
| iPhone 14 Pro | 7999 | 10   |
| iPhone 13 Pro | 5999 | 0    |

然后创建一个基于订单数据表事件的工作流：

<figure>
  <img alt="数据表事件_示例_新增订单触发" src="https://github.com/nocobase/nocobase/assets/525658/057733a5-db79-4d57-b2d1-84cad4af5191" width="680">
</figure>

其中的几个配置项：

- 数据表：选择“订单”表。
- 触发时机：选择“新增数据后”触发。
- 触发条件：留空。
- 预加载关系数据：勾选“商品”。

之后根据流程的逻辑配置其他节点，检查商品库存是否大于 0，大于 0 的扣减库存，否则订单无效删除订单：

<figure>
  <img alt="数据表事件_示例_新增订单流程编排" src="https://github.com/nocobase/nocobase/assets/525658/887d4af7-a638-47d0-81ae-aa9b4a29c4b9" width="731">
</figure>

节点的配置会在具体类型的介绍文档中详细说明。

启用该工作流，并通过界面新增订单来测试。对“iPhone 14 Pro”下单后，对应商品的库存会扣减为 9，而如果对“iPhone 13 Pro”下单，由于库存不足，订单将被删除。

<figure>
  <img alt="数据表事件_示例_新增订单执行结果" src="https://github.com/nocobase/nocobase/assets/525658/7a8d2cdb-8038-4276-84ed-cf8a2177e48d" width="902">
</figure>
