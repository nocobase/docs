# ソートフィールド

<PluginInfo name="field-sort"></PluginInfo>

## 概要

ソートフィールドは、データテーブル内のレコードをソートするために使用され、グループ化した後にソートする（sort1）ことをサポートしています。

:::warning
ソートフィールドは同じテーブルのフィールドであるため、グループソート時には同じレコードが複数のグループに分けられることはできません。
:::

## インストール

内蔵プラグインのため、別途インストールは不要です。

## 使用マニュアル

### ソートフィールドの作成

![20240409091123_rec_](https://static-docs.nocobase.com/20240409091123_rec_.gif)

ソートフィールドを作成する際、ソート値が初期化されます：

- グループソートを選択しない場合、主キーと作成日フィールドに基づいて初期化されます。
- グループソートを選択した場合、データをグループ化した後、主キーと作成日フィールドに基づいて初期化されます。

:::warning{title="トランザクションの一貫性に関する説明"}
- フィールド作成時にソート値の初期化が失敗した場合、ソートフィールドは作成されません。
- 特定の範囲内で、あるレコードが A 位置から B 位置に移動すると、AB区間内のすべてのレコードのソート値が変更されます。1つでも失敗があれば、移動は失敗し、関連するレコードのソート値は変更されません。
:::

#### 例1：sort1 フィールドの作成

sort1 フィールドはグループなし

![20240409091510](https://static-docs.nocobase.com/20240409091510.png)

各レコードのソートフィールドは主キーと作成日フィールドに基づいて初期化されます：

![20240409092305](https://static-docs.nocobase.com/20240409092305.png)

#### 例2：Class ID に基づいてグループ化された sort2 フィールドの作成

![20240409092620](https://static-docs.nocobase.com/20240409092620.png)

この場合、データテーブル内のすべてのレコードをまずグループ化（Class ID に基づいて）し、その後ソートフィールド（sort2）の初期化が行われます。各レコードの初期化値は次の通りです：

![20240409092847](https://static-docs.nocobase.com/20240409092847.png)

### ドラッグ＆ドロップソート

ソートフィールドは、さまざまなブロック記録をドラッグ＆ドロップで並び替えるために主に使用されます。現在、ドラッグ＆ドロップによる並び替えがサポートされているブロックは、テーブルとカンバンです。

:::warning
- 同じ並べ替えフィールドをドラッグ＆ドロップ並べ替えとして使用する場合、複数のブロックを混ぜ合わせると、既存の並べ替えが壊れてしまうことがあります。
- グループ化ルールを持つ並べ替えフィールドは、テーブルのドラッグ＆ドロップで並べ替えフィールドを選択できません。
  - 例外：一対多の関係のテーブルブロックでは、外部キーをグループ化として使用できます。
- 現在、カンバンブロックのみがグループ化されたドラッグ＆ドロップをサポートしています。
:::

#### テーブル行のドラッグ＆ドロップ並び替え

テーブルブロック

![20240409104621_rec_](https://static-docs.nocobase.com/20240409104621_rec_.gif)

関係テーブルブロック

<video controls width="100%" src="https://static-docs.nocobase.com/20240409111903_rec_.mp4" title="Title"></video>

:::warning
一対多関係のブロック内

- 未グループ化のソートフィールドを選択した場合、すべてのレコードが並び替えに参加する可能性があります。
- 外部キーに基づいて先にグループ化してから並び替えると、並び替えルールは現在のグループ内のデータにのみ影響します。

最終的な効果は一貫していますが、並び替えに参加するレコード数は異なります。詳細は[並び替えルールの説明](#並び替えルールの説明)をご覧ください。
:::

#### カンバンカードのドラッグ＆ドロップ並び替え

![20240409110423_rec_](https://static-docs.nocobase.com/20240409110423_rec_.gif)

### 並び替えルールの説明

#### 未グループ化（または同グループ）要素間の移動

例えば、以下のデータがあるとします。

```
[1,2,3,4,5,6,7,8,9]
```

ある要素、例えば 5 を前に移動して 3 の位置に移動すると、その時点で 3,4,5 のインデックスだけが変動し、5 が 3 の位置を占有します。3 と 4 はそれぞれ1つ後ろに移動します。

```
[1,2,5,3,4,6,7,8,9]
```

その後、6 を後ろに移動して 8 の位置に移動すると、6 が 8 の位置を占有し、7 と 8 はそれぞれ1つ前に移動します。

```
[1,2,5,3,4,7,8,6,9]
```

#### 異なるグループ間の要素の移動

グループ化されたソートの際、あるレコードが他のグループに移動すると、そのレコードの所属グループも変更されます。例えば以下の例：

```
A: [1,2,3,4]
B: [5,6,7,8]
```

1を6に移動すると（デフォルトでは後ろに）、1が所属するグループもAからBに変更されます。

```
A: [2,3,4]
B: [5,6,1,7,8]
```

#### ソートの変更はインターフェースに表示されるデータとは無関係です。

例えば、次のようなデータセットがあるとします。

```
[1,2,3,4,5,6,7,8,9]
```

インターフェイスには次のようにしか表示されません。

```
[1,5,9]
```

1が9の位置に移動すると、中間の2,3,4,5,6,7,8のデータの位置がすべて変更されます。

```
[2,3,4,5,6,7,8,9,1]
```

インターフェイスには次のようにしか表示されません。

```
[5,9,1]
```

