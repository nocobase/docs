# 集計クエリ

<PluginInfo name="workflow-aggregate" link="/handbook/workflow-aggregate"></PluginInfo>

特定のデータテーブルにおいて条件を満たすデータに対して集計関数を実行し、対応する統計結果を返します。主にレポート関連の統計データの処理に使用されます。

ノードの実装はデータベースの集計関数に基づいており、現在は1つのデータテーブルの単一フィールドに対する統計のみをサポートしています。統計結果の数値はノードの結果に保存され、後続の他のノードで利用可能です。

## インストール

内蔵プラグインのため、インストールは不要です。

## 使用マニュアル

### ノードの作成

ワークフロー設定画面で、プロセス内のプラス（“+”）ボタンをクリックし、「集計クエリ」ノードを追加します：

![集計クエリノードの作成](https://static-docs.nocobase.com/7f9d806ebf5064f80c30f8b67f316f0f.png)

### ノード設定

![集計クエリノード_ノード設定](https://static-docs.nocobase.com/57362f747b9992230567c6bb5e986fd2.png)

#### 集計関数

SQLの `COUNT`、`SUM`、`AVG`、`MIN`、`MAX` の5種類の集計関数をサポートしており、その中から1つを選択してデータを集計します。

#### 目標タイプ

集計クエリの目標は2つのモードから選択できます。一つは直接目標データテーブルとその中のフィールドを選択する方法、もう一つはプロセスのコンテキストにあるデータオブジェクトを通じて、多対多の関係データテーブルとフィールドを選択し、集計クエリを行う方法です。

#### 重複排除

SQLの `DISTINCT` に相当し、重複排除のフィールドは選択されたデータテーブルのフィールドと同じで、一時的に異なるフィールドの選択はサポートされていません。

#### フィルタ条件

通常のデータテーブルクエリ時のフィルタ条件に似ており、プロセスのコンテキスト変数を使用できます。

### 例

集計対象を「データテーブルデータ」とするのは比較的理解しやすいため、ここでは「新規追加された記事のカテゴリにおける総記事数の統計」を例に、集計対象が「関連データテーブルデータ」の使い方を紹介します。

まず、2つのデータテーブル「記事」と「カテゴリ」を作成します。記事には多対一の関係フィールドがあり、カテゴリテーブルを指します。また、逆関係フィールドとして、カテゴリが多対一の記事を持つように設定します：

| フィールド名 | タイプ         |
| ------------ | -------------- |
| タイトル     | 単一行テキスト |
| 所属カテゴリ | 多対一（カテゴリ） |

| フィールド名   | タイプ           |
| -------- | -------------- |
| 分類名   | 単一行テキスト  |
| 含む記事 | 一対多（記事）  |

次に、データテーブルイベントトリガーによるワークフローを作成し、記事テーブルに新しいデータが追加された後にトリガーされるように設定します。

その後、集計クエリノードを追加し、以下のように設定します：

![集約クエリノード_例_ノード設定](https://static-docs.nocobase.com/542272e638c6c0a567373d1b37ddda78.png)

これにより、ワークフローがトリガーされると、集計クエリノード内で新規記事のカテゴリに属するすべての記事の数が集計され、ノードの結果として保存されます。

:::info{title=ヒント}
データテーブルイベントトリガーで関連データを使用する必要がある場合は、トリガー内で「関連データを事前読み込み」の関連フィールドを設定する必要があります。そうしないと選択できません。
:::

