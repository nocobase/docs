# Webhookイベント

<PluginInfo name="workflow-webhook" link="/handbook/workflow-webhook" commercial="true"></PluginInfo>

Webhookトリガーは、サードパーティシステムがHTTP POSTリクエストを介して呼び出すためのシステム生成URLを提供します。このURLは、支払いのコールバックや通知などの特定のイベントが発生したときにワークフローの実行をトリガーします。外部システムからの通知に適しています。

## ユーザーガイド

### トリガーの作成

ワークフローを作成し、ワークフローのタイプとして「Webhookイベント」を選択します。

![20241210105049](https://static-docs.nocobase.com/20241210105049.png)

:::info{title="ヒント"}
「同期」と「非同期」ワークフローの主な違いは、応答の動作にあります。同期ワークフローはワークフローの実行が完了するまで待機してから応答を返します。対照的に、非同期ワークフローは事前に設定された応答を即座に返し、その後バックグラウンドでワークフローを実行します。
:::

### トリガーの設定

![20241210105441](https://static-docs.nocobase.com/20241210105441.png)

#### Webhook URL

WebhookトリガーのURLはシステムによって自動生成され、このワークフローに紐付けられます。右側のコピー ボタンをクリックして、URLをサードパーティシステムに貼り付けてください。

HTTPメソッドはPOSTのみサポートされており、他のメソッドを使用すると `405` エラーが返されます。

#### セキュリティ

現在、HTTP基本認証がサポートされています。このオプションを有効にし、ユーザー名とパスワードを設定することで、Webhookを保護できます。サードパーティシステムは認証のためにWebhook URLにユーザー名とパスワードを含める必要があります（詳細: [MDN: HTTP認証](https://developer.mozilla.org/ja/docs/Web/HTTP/Authentication#basic_authentication_scheme)）。

ユーザー名とパスワードが設定されている場合、システムはリクエスト内のユーザー名とパスワードが一致するかどうかを確認し、一致しない場合や提供されていない場合は `401` エラーを返します。

#### リクエストデータの解析

サードパーティがWebhookを呼び出す際にリクエストに含まれるデータは、ワークフロー内で使用するために解析する必要があります。解析後はトリガー変数として利用でき、後続のノードで参照できます。

HTTPリクエストの解析は以下の3つの部分に分かれます：

1. **リクエストヘッダー**

   リクエストヘッダーは通常、単純な文字列形式のキーとバリューのペアです。必要なリクエストヘッダーフィールド（例: `Date`、`X-Request-Id`など）を直接設定できます。

2. **リクエストパラメータ**

   リクエストパラメータはURLのクエリパラメータ部分です。例: `http://localhost:13000/api/webhook:trigger/1hfmkioou0d?query=1` の `query` パラメータ。完全なURLサンプルを貼り付けるか、クエリパラメータ部分のみを貼り付けて解析ボタンをクリックすると、キーとバリューのペアが自動的に解析されます。

   ![20241210111155](https://static-docs.nocobase.com/20241210111155.png)

   自動解析では、URLのパラメータ部分をJSON構造に変換し、`query[0]`、`query[0].a` などのパスを生成します。パス名は要件に合わない場合は手動で変更できますが、通常は変更の必要はありません。エイリアスは、変数として使用する際の表示名としてオプションです。同時に、サンプル内の全パラメータテーブルが生成されます。不要なパラメータがある場合は削除できます。

3. **リクエストボディ**

   リクエストボディはHTTPリクエストのボディ部分です。現在、`Content-Type`が`application/json`形式のリクエストボディのみがサポートされています。解析するパスを直接設定するか、JSONサンプルを入力して解析ボタンをクリックして自動解析します。

   ![20241210112529](https://static-docs.nocobase.com/20241210112529.png)

   自動解析では、JSON構造のキーとバリューのペアをパスに変換します。例えば、`{"a": 1, "b": {"c": 2}}` は `a`、`b`、`b.c` のパスを生成します。エイリアスは、変数として使用する際の表示名としてオプションです。同時に、サンプル内の全パラメータテーブルが生成されます。不要なパラメータがある場合は削除できます。

#### 応答設定

Webhookの応答部分は、同期ワークフローと非同期ワークフローで設定方法が異なります。

- **非同期ワークフロー**: トリガー内で直接設定されます。Webhookリクエストを受信すると、トリガー内の応答設定が即座にサードパーティシステムに返され、その後ワークフローが実行されます。

- **同期ワークフロー**: ビジネス要件に応じてプロセス内に応答ノードを追加して処理する必要があります（詳細: [応答ノード](#応答ノード)）。

通常、非同期的にトリガーされたWebhookイベントの応答はステータスコード `200` と応答ボディ `ok` です。必要に応じて、ステータスコード、応答ヘッダー、および応答ボディをカスタマイズすることもできます。

![20241210114312](https://static-docs.nocobase.com/20241210114312.png)

### 応答ノード

応答ノードは、同期モードのWebhookワークフローでのみサポートされ、サードパーティシステムに返される応答を処理します。例えば、支払いコールバックの処理中に予期しない結果（エラーや失敗など）が発生した場合、応答ノードを使用してサードパーティシステムにエラー応答を返すことができ、一部のサードパーティシステムはステータスに基づいて後で再試行できます。

さらに、応答ノードの実行はワークフローの実行を終了し、後続のノードは実行されません。ワークフロー全体に応答ノードが設定されていない場合、システムはプロセス実行の状態に応じて自動的に応答し、正常な実行では `200` を、失敗した実行では `500` を返します。

#### 応答ノードの作成

ワークフロー設定画面で、プロセス内のプラスボタン（「+」）をクリックして「応答」ノードを追加します。

![20241210115120](https://static-docs.nocobase.com/20241210115120.png)

#### 応答設定

![20241210115500](https://static-docs.nocobase.com/20241210115500.png)

ワークフローコンテキスト内の変数を応答ボディで使用できます。

#### 例

同期モードのWebhookワークフローでは、ビジネス条件に応じて異なる応答を返すことができます。以下の図のように設定します。

![20241210120655](https://static-docs.nocobase.com/20241210120655.png)

条件分岐ノードを使用して、特定のビジネスステータスが満たされているかどうかを判断します。満たされている場合は成功メッセージを返し、そうでない場合は失敗メッセージを返します。
