# 定期タスク

定期タスクは、時間をトリガー条件としたイベントで、2つのモードに分かれます。

- カスタム時間：一般的なcronのように、システム時間に基づいてトリガーされます。
- データテーブルの時間フィールド：データテーブル内の時間フィールドの値に基づいてトリガーされます。

システムが設定されたトリガー条件を満たす時間点（秒単位）に達すると、対応するワークフローがトリガーされます。

## 基本的な使い方

### 定期タスクの作成

ワークフローリストで、ワークフローのタイプとして「定期タスク」を選択します：

![定期タスクの作成](https://static-docs.nocobase.com/e09b6c9065167875b2ca7de5f5a799a7.png)

### カスタム時間モード

通常のモードでは、最初に任意の時間点（秒単位）を開始時間として設定する必要があります。開始時間は未来の時間に設定することも、過去の時間に設定することもできます。過去の時間に設定した場合、設定された繰り返し条件に基づいて到達の確認が行われ、繰り返し条件が設定されていない場合、開始時間が過去であればワークフローはトリガーされません。

繰り返しルールには2つの設定方法があります：

- インターバル時間に基づく：開始時間から固定の間隔でトリガーされる（例：毎時、30分ごとなど）。
- 高度なモード：cronルールに従い、固定の日時に到達する周期を設定できます。

繰り返しルールを設定した後、終了条件も設定できます。固定の時間点で終了することも、実行回数で制限することも可能です。

### データテーブルの時間フィールドモード

データテーブルの時間フィールドを使用して開始時間を決定するモードは、通常の定期タスクとデータテーブルの時間フィールドを組み合わせたトリガーモードです。このモードを使用すると、特定のフロー内のノードが簡素化され、設定もより直感的になります。例えば、支払い期限を過ぎた未払いの注文をキャンセル済みの状態に変更するには、データテーブルの時間フィールドモードの定期タスクを設定し、開始時間を注文作成から30分後に選択するだけです。

## 関連のヒント

### 未起動または停止状態の定期タスク

設定された時間条件が満たされた場合でも、NocoBaseアプリケーションサービス全体が未起動または停止状態の場合、対応する時間点でトリガーされるべき定期タスクは見逃されます。また、サービスが再起動された後に、すでに見逃されたタスクは再度トリガーされません。そのため、使用時には対応状況の処理や代替策を考慮する必要があります。

### 繰り返し回数

終了条件における繰り返し回数が設定されている場合、計算されるのは同一ワークフローのすべてのバージョンで実行された合計回数です。例えば、バージョン1の時点で定期タスクが10回実行された場合、繰り返し回数が10回に設定されていると、そのワークフローはトリガーされなくなります。新しいバージョンにコピーされてもトリガーされず、繰り返し回数が10以上に変更されない限り発動しません。しかし、ワークフローを新規にコピーした場合、実行回数はゼロから再計算され、関連設定を変更しない限り、新しいワークフローは再度10回トリガーされることが可能です。

### 繰り返しルールの間隔時間と高度なモードの違い

繰り返しルールの間隔時間は、前回のトリガー（開始時間）に相対する時間を基準としていますが、高度なモードは固定の時間ポイントでトリガーされます。例えば、30分ごとにトリガーされるように設定した場合、前回のトリガーが2021-09-01 12:01:23であれば、次回のトリガー時間は2021-09-01 12:31:23となります。一方、高度なモード、すなわちcronモードでは、設定されたルールはすべて固定の時間ポイントでトリガーされます。たとえば、毎時01分と31分にトリガーされるように設定できます。

## 例

毎分、作成後30分を超えて未完成の支払いの注文をチェックし、自動的にキャンセル状態に変更することを想定します。2つのモードを使用して実現します。

### カスタム時間モード

定期タスクに基づいたワークフローを作成し、トリガー設定で「カスタム時間」モードを選択します。開始時間は現在の時間より遅くない任意の時間点を選び、繰り返しルールは「毎分」を選択し、終了条件は空白にします：

![定期タスク_トリガー設定_カスタム時間モード](https://static-docs.nocobase.com/71131e3f2034263f883062389b356cbd.png)

その後、フローのロジックに従って他のノードを設定し、30分前の時間を計算し、その前に作成された未払いの注文をキャンセル状態に変更します：

![定期タスク_トリガー設定_カスタム時間モード](https://static-docs.nocobase.com/188bc5287ffa1fb24a4e7baa1de6eb29.png)

ワークフローが有効になると、開始時間から毎分トリガーされ、30分前の時間を計算して、その時間点よりも早く作成された注文の状態をキャンセルに更新します。

### データテーブル時間フィールドモード

定期タスクに基づいたワークフローを作成し、トリガー設定で「データテーブル時間フィールド」モードを選択します。データテーブルには「注文」テーブルを選び、開始時間を注文の作成時間の30分後に設定し、繰り返しルールは「繰り返さない」を選択します：

![定期タスク_トリガー設定_データテーブル時間フィールドモード_トリガー](https://static-docs.nocobase.com/d40d5aef57f42799d31cc5882dd94246.png)

その後、プロセスのロジックに従って他のノードを設定し、IDをトリガーデータIDに更新して、状態が「未払い」の注文をキャンセル状態にします：

![定期タスク_トリガー設定_データテーブル時間フィールドモード_更新ノード](https://static-docs.nocobase.com/491dde9df8f773f5b14a4fd8ceac9d3e.png)

カスタム時間モードとは異なり、ここでは30分前の時間を計算する必要はありません。なぜなら、ワークフローのトリガーデータコンテキストには、時間条件に合致するデータ行が含まれているため、対応する注文の状態を直接更新できるからです。

