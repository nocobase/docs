# データテーブルイベント

データテーブルイベントタイプのトリガーは、データテーブルの追加、削除、更新、検索イベントをリスンします。データテーブルに対する操作が行われ、設定された条件を満たすと、対応するワークフローがトリガーされます。例えば、注文を追加した後に商品の在庫を減少させたり、コメントを追加した後に人間のレビューを待ったりするシナリオが考えられます。

## 基本使用法

データテーブルの変動にはいくつかの状況があります：

1. データを新規追加した後。
2. データを更新した後。
3. データを新規追加または更新した後。
4. データを削除した後。

![データテーブルイベント_トリガーのタイミング選択](https://static-docs.nocobase.com/81275602742deb71e0c830eb97aa612c.png)

ビジネスの異なるニーズに応じて、トリガーのタイミングを選択できます。データテーブルの更新を含む状況を選択した場合、変更が発生するフィールドを指定することも可能です。選択したフィールドが変更された時のみトリガー条件を満たし、選択しない場合はすべてのフィールドの変更がトリガーを引き起こします。

![データテーブルイベント_発生した変更のフィールド選択](https://static-docs.nocobase.com/874a1475f01298b3c00267b2b4674611.png)

さらに、トリガーされるデータ行の各フィールドに条件ルールを設定でき、そのフィールドが相応の条件を満たす場合にのみトリガーが行われます。

![データテーブルイベント_データが満たす条件の設定](https://static-docs.nocobase.com/264ae3835dcd75cee0eef7812c11fe0c.png)

データテーブルイベントがトリガーされると、実行計画にイベントを生成したデータ行がトリガーコンテキストデータとして注入され、後続のプロセス内のノードで変数として参照されます。ただし、後続のノードでそのデータの関連フィールドを使用したい場合は、まず関連データの事前ロードを設定する必要があります。選択された関連データはトリガー後にコンテキストに一緒に注入され、階層に基づいて選択して使用することができます。

## 関連ヒント

### 現在、バッチデータ操作トリガーはサポートされていません

データテーブルイベントは、バッチデータ操作のトリガーをサポートしていません。例えば、記事データを追加する際に同時にその記事の複数のタグデータ（多対多関係データ）を追加した場合、記事の追加に対するワークフローのみがトリガーされ、同時に追加された複数のタグは追加タグのワークフローをトリガーしません。多対多関係データの関連と追加時にも、中間テーブルのワークフローはトリガーされません。

### アプリ内でないデータ操作はトリガーされません

HTTP APIを介してアプリケーションインターフェースでデータテーブルを操作することでも相応のイベントをトリガーできますが、NocoBaseアプリを介さずに直接データベース操作によって発生したデータ変動では、相応のイベントをトリガーすることはできません。例えば、データベース内のトリガーはアプリ内のワークフローと関連付けられません。

また、SQL操作ノードを使用してデータベースを操作することは、データベースを直接操作することと同等であり、データテーブルイベントはトリガーされません。

### 外部データソース

ワークフローは `0.20` から外部データソースをサポートしています。外部データソースプラグインを使用し、データテーブルイベントが外部データソースに設定されている場合、データソースのデータ操作がアプリケーション内で行われる限り（ユーザーによる追加、更新、ワークフローデータ操作など）、対応するデータテーブルイベントをトリガーできます。ただし、データの変更が他のシステムを通じて行われたり、外部データベース内で直接変更された場合、データテーブルイベントはトリガーされません。

## 実例

新しい注文を追加した後に総価格を計算し、在庫を減少させるシナリオの例を示します。

まず、商品テーブルと注文テーブルを作成し、データモデルは以下の通りです：

| フィールド名 | フィールドタイプ |
| ------------ | ---------------- |
| 商品名      | 単一行テキスト     |
| 価格        | 数字              |
| 在庫        | 整数              |

| フィールド名 | フィールドタイプ       |
| ------------ | --------------------- |
| 注文番号    | 自動番号              |
| 注文商品    | 多対一（商品）        |
| 注文合計    | 数字                  |

基本的な商品データを追加します：

| 商品名      | 価格 | 在庫 |
| ----------- | ---- | ---- |
| iPhone 14 Pro | 7999 | 10   |
| iPhone 13 Pro | 5999 | 0    |

次に、注文データテーブルイベントに基づいたワークフローを作成します：

![データテーブルイベント_サンプル_新規注文トリガー](https://static-docs.nocobase.com/094392a870dddc65aeb20357f62ddc08.png)

いくつかの設定項目は以下の通りです：

- データテーブル： 「注文」テーブルを選択。
- トリガータイミング： 「新規データ後」を選択。
- トリガー条件： 空白のまま。
- 関連データの事前ロード： 「商品」にチェックを入れる。

その後、フローの論理に従って他のノードを設定し、商品在庫が 0 より大きいかを確認し、大きい場合は在庫を減少させ、そうでない場合は注文を無効にして削除します：

![データテーブルイベント_サンプル_新規注文フロー編成](https://static-docs.nocobase.com/7713ea1aaa0f52a0dc3c92aba5e58f05.png)

ノードの設定は、具体的なタイプの紹介文書で詳しく説明します。

このワークフローを有効にし、インターフェースから新しい注文を追加してテストします。「iPhone 14 Pro」を注文すると、対応商品の在庫が9に減少しますが、「iPhone 13 Pro」を注文すると、在庫不足のため注文はキャンセルされます。

![データテーブルイベント_サンプル_新規注文実行結果](https://static-docs.nocobase.com/24cbe51e24ba4804b3bd48d99415c54f.png)

