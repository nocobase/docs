# 演算

演算ノードはフローを制御するものではありませんが、フロー内で重要な機能を持っています。演算ノードは式を評価し、その結果を対応するノードの結果に保存し、後続のノードで使用できるようにします。データを計算、処理、変換するためのツールであり、一定の範囲でプログラミング言語における計算関数の呼び出しと変数への代入機能を代替することができます。

## ノードの作成

ワークフロー設定画面で、フロー内のプラス（“+”）ボタンをクリックして「演算」ノードを追加します：

![演算ノード_追加](https://static-docs.nocobase.com/58a455540d26945251cd143eb4b16579.png)

## ノードの設定

![演算ノード_ノード設定](https://static-docs.nocobase.com/6a155de3f6a883d8cd1881b2d9c33874.png)

### 演算エンジン

演算エンジンは、式がサポートする構文を定義します。現在サポートされている演算エンジンには [Math.js](https://mathjs.org/) と [Formula.js](https://formulajs.info/) があり、それぞれに多くの一般的な関数やデータ操作のメソッドが内蔵されています。具体的な使用法については公式ドキュメントを参照してください。

:::info{title=ヒント}
異なるエンジンでは配列のインデックスアクセスに違いがあるため、注意が必要です。Math.js のインデックスは `1` から始まり、Formula.js は `0` から始まります。
:::

また、簡単な文字列の結合が必要な場合は「文字列テンプレート」を直接使用できます。このエンジンは式内の変数を対応する値に置き換え、結合された文字列を返します。

### 式

式は演算公式の文字列表現であり、変数、定数、演算子、およびサポートされている関数などで構成されます。フローのコンテキスト内の変数を使用でき、例えば演算ノードの前のノードの結果やループのローカル変数などが含まれます。

式の入力が構文に合わない場合、ノードの設定でエラーが表示されます。実行時に変数が存在しない、または型が一致しない、もしくは存在しない関数を使用した場合、演算ノードはエラー状態で早期に終了します。

## 例

### 注文の総額を計算

通常、1つの注文には複数の商品があり、それぞれの商品の価格と数量は異なります。注文の総額は、すべての商品価格と数量の積の合計を計算する必要があります。注文明細リスト（多対多関係データセット）を読み込んだ後、演算ノードを使用して注文の総額を計算できます：

![演算ノード_例_ノード設定](https://static-docs.nocobase.com/85966b0116afb49aa966eeaa85e78dae.png)

Formula.jsの `SUMPRODUCT` 関数を使用すると、同じ長さの2つの配列の各要素の積の合計を計算できます。これにより、注文の総額を得ることが可能です。

