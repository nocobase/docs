# 変数の使用

## コア概念

プログラミング言語における変数と同様に、ワークフローにおいて**変数**はプロセスを接続し整理するための重要なツールです。

ワークフローがトリガーされた後、各ノードを実行する際に、一部の設定項目では変数の使用が選択できます。変数のソースは、そのノードの上流ノードのデータで、以下のカテゴリに分かれます：

- **トリガーコンテキストデータ**：操作トリガーやデータテーブルトリガーの場合、単一のデータオブジェクトはすべてのノードで変数として使用されます。具体的には各トリガーの実装に依存します。
- **上流ノードデータ**：プロセスが任意のノードに到達する際、前に完了したノードの結果データを参照します。
- **ローカル変数**：ノードが特定の分岐構造内にある場合、その分岐特有のローカル変数を使用できます。例えば、ループ構造内では各ループのデータオブジェクトを使用できます。
- **システム変数**：現在の時間などのビルトインシステムパラメータを含みます。

私たちは [クイックスタート](../quick-start.md) で変数の機能を何度も使用してきました。例えば、計算ノードでは、変数を使用してトリガーコンテキストデータを参照し、計算を行うことができます：

![計算ノードでの関数と変数の使用](https://static-docs.nocobase.com/837e4851a4c70a1932542caadef3431b.png)

更新ノードでは、トリガーコンテキストデータをフィルタ条件の変数として使用し、計算ノードの結果を更新データのフィールド値の変数として参照します：

![更新データノードの変数](https://static-docs.nocobase.com/2e147c93643e7ebc709b9b7ab4f3af8c.png)

## データ構造

変数の内部はJSON構造で、通常はJSONパスを使用してデータの特定部分にアクセスできます。多くの変数はNocoBaseのデータテーブル構造に基づいており、関連データはオブジェクトの属性として階層的に木構造を形成します。例えば、関連データの特定のフィールドの値を取得することができます。また、関連データが多対多の構造の場合、変数は配列となることがあります。

変数を選択する際、大抵は最終階層の値属性を選ぶ必要があり、通常は数値や文字列などのシンプルなデータ型です。ただし、変数の階層に配列が含まれている場合、末端の属性も配列としてマッピングされるため、対応するノードが配列をサポートしている場合にのみ、配列データを正しく処理できます。例えば、計算ノードでは、特定の計算エンジンが配列を処理するための関数を持っていることがあります。また、ループノードでは、ループオブジェクトが直接配列を選択できる場合もあります。

例として、クエリノードが複数のデータをクエリした場合、ノードの結果は同様のデータを含む複数行の配列になります。

```json
[
  {
    "id": 1,
    "title": "タイトル1"
  },
  {
    "id": 2,
    "title": "タイトル2"
  }
]
```

しかし、後続のノードで変数として使用する際に、選択した変数が `ノードデータ/クエリノード/タイトル` の形式の場合、対応するフィールド値の配列が得られます：

```json
["タイトル1", "タイトル2"]
```

もし多次元配列（例えば多対多関係フィールド）の場合、対応するフィールドがフラット化された一時配列が得られます。

## システム内蔵変数

### システム時間

実行中のノードに基づいて、実行時のシステム時間を取得します。この時間のタイムゾーンはサーバー設定のタイムゾーンに従います。

### 日付範囲パラメータ

クエリ、更新、削除ノードで、日付フィールドのフィルタ条件を設定する際に使用できます。 “等しい” 比較のみに対応しており、日付範囲の開始・終了時間点はサーバー設定のタイムゾーンに基づいています。

![日付範囲パラメータ](https://static-docs.nocobase.com/20240817175354.png)

