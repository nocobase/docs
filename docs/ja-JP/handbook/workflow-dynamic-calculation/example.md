上記の設定手順に基づき、商品注文プロセスにおいて異なる商品に応じた異なる割引ルールの最終価格計算の例を示します。

1. 商品表の作成：

    | フィールド名   | タイプ                      |
    | -------------- | --------------------------- |
    | 商品名         | テキスト                    |
    | 商品原価       | 数字                        |
    | 割引ルール     | `belongsTo`（割引ルール表） |

2. 割引ルール表の作成（式表テンプレートを使用）：

    | フィールド名   | タイプ                     |
    | -------------- | -------------------------- |
    | ルール名       | テキスト                   |
    | データ表       | 単一選択（データ表）       |
    | 計算エンジン   | 単一選択（mathjs/formulajs） |
    | 表現           | テキスト                   |

3. 割引ルールの入力：

    | ID  | 名称       | データ表 | 計算エンジン   | 表現                    |
    | --- | ---------- | -------- | -------------- | ----------------------- |
    | 1   | 20%オフ商品 | 商品     | formula.js     | `{{商品.価格}} * 0.8`  |
    | 2   | 10%オフ商品 | 商品     | formula.js     | `{{商品.価格}} * 0.9`  |

4. 商品の作成と割引ルールの関連付け：

    | ID  | 商品名       | 価格  | 割引ルール |
    | --- | ------------ | ----- | ---------- |
    | 1   | iPhone 14 Pro | 7999  | 2          |
    | 2   | iPhone 13 Pro | 6999  | 1          |

5. ワークフローを作成し、注文作成時にトリガーします：

![トリガー_注文トリガーの作成](https://static-docs.nocobase.com/f181f75b10007afd5de068f3458d2e04.png)

6. 動的式計算ノードを作成し、動的式をトリガーデータ/商品/割引ルールとして設定します：

![動的式データの選択](https://static-docs.nocobase.com/21ccc63e604dd90b7d26c3c33c12d671.png)

トリガーデータの商品の変数データソースを設定します：

![変数データソースの選択](https://static-docs.nocobase.com/afbffe9661539d26e4b175ae8a4b28f7.png)

7. データ更新ノードを追加し、計算ノードの結果をもとに注文の合計金額を更新します：

![注文データの更新](https://static-docs.nocobase.com/5cc7ffb113c8d6a2fd3b1b34abe06dcc.png)

8. 注文トリガーのワークフローを作成し、注文リストを確認して価格を照合します：

| 注文商品      | 注文商品 / 原価 | 割引ルール | 合計金額                |
| ------------- | --------------- | -------- | ----------------------- |
| iPhone 14 Pro | 7999            | 10%オフ   | 7999 * 0.9 = 7199.1     |
| iPhone 13 Pro | 6999            | 20%オフ   | 6999 * 0.8 = 5599.2     |

下図の合計金額は上表の合計金額と一致する必要があります：

![注文作成後自動計算された注文の合計金額](https://static-docs.nocobase.com/a5610aca292e79c4841c97457bd3cc7c.png)

:::info{title=ヒント}
ワークフローは非同期で実行されるため、注文を作成した直後は表の更新結果に合計金額が含まれない場合があります。しばらく待ってから再度更新して確認してください。 
:::

