# デフォルト値

## 紹介

デフォルト値は、フィールドが新規作成された際の初期値です。データテーブルのフィールド設定時にデフォルト値を設定することも、新規フォームブロック内でフィールドにデフォルト値を指定することも可能で、定数または変数として設定できます。

## デフォルト値を設定できる場所

### データテーブルフィールド

![20240411095933](https://static-docs.nocobase.com/20240411095933.png)

### 新規フォームのフィールド

新規フォームのほとんどのフィールドは、デフォルト値の設定をサポートしています。

![20240411100030](https://static-docs.nocobase.com/20240411100030.png)

### サブフォームの追加

新規作成または編集フォーム内のサブフォームフィールドに追加されるサブデータには、デフォルト値が設定されています。

サブフォームの「新規追加」

![20240411100341](https://static-docs.nocobase.com/20240411100341.png)

サブテーブルの「新規追加」

![20240411100424](https://static-docs.nocobase.com/20240411100424.png)

![20240411100634](https://static-docs.nocobase.com/20240411100634.png)

既存のデータを編集する際、データが空の場合はデフォルト値で埋められません。新しく追加されたデータのみがデフォルト値で埋められますが、保存はされません。

![20240411100729](https://static-docs.nocobase.com/20240411100729.png)

### 関係データのデフォルト値

「**多対一**」および「**多対多**」タイプの関係において、使用されるセレクターコンポーネント（Select、RecordPicker）を利用する場合にのみデフォルト値が設定されます。

![20240411101025](https://static-docs.nocobase.com/20240411101025.png)

## デフォルト値変数

### どのような変数があるか

- 日付変数
- 現在のユーザー
- 現在のレコード（既存のデータにのみ適用される）
- 現在のフォーム（理想的にはフォーム内のフィールドのみをリストアップ）
- 現在のオブジェクト（サブフォーム内の各行データオブジェクト）
- フォーム選択記録（現在は「テーブルブロック + レコード追加フォーム」の組み合わせに限る）

より多くの変数内容については[変数](/handbook/ui/variables)を参照してください。

### フィールドのデフォルト値変数

非関係フィールドと関係フィールドの2種類に分かれます。

#### 関係フィールドのデフォルト値変数

- 変数オブジェクトはコレクションのレコードでなければなりません。
- 継承チェーン上のテーブルでなければなりません。現在のテーブルでも、親子テーブルでも可能です。
- 「フォームで選択されたレコード」変数は「多対多」と「一対多/多対一」関係フィールド内に限って使用可能です。
- **多層の場合、平坦化して重複を排除する必要があります。**

```typescript
// テーブルで選択されたレコード：
[{id:1},{id:2},{id:3},{id:4}]

// テーブルで選択されたレコード/対一：
[{対一: {id:2}}, {対一: {id:3}}, {対一: {id:3}}] 
// 平坦化して重複を排除
[{id: 2}, {id: 3}]

// テーブルで選択されたレコード/対多：
[{対多: [{id: 1}, {id:2}]}, {対多: [{id:3}, {id:4}]}]
// 平坦化  
[{id:1},{id:2},{id:3},{id:4}]
```

#### 非関係デフォルト値変数

- タイプが一致または互換性がある場合、例えば文字列は数字と互換性があり、toStringメソッドを提供するすべてのオブジェクトが含まれます。
- JSONフィールドは特に特殊で、任意のデータを保存できます。

### フィールドレベル（オプションフィールド）

![20240411101157](https://static-docs.nocobase.com/20240411101157.png)

- 非関係デフォルト値変数
  - 多層選択フィールドの場合、対一の関係に限られ、多対多の関係はサポートされていません。
  - JSONフィールドは特に特殊で、制限はありません。

- 関係デフォルト値変数
  - hasOneは対一関係のみをサポートします。
  - hasManyは対一（内部変換）と対多の両方をサポートします。
  - belongsToManyは対一（内部変換）と対多の両方をサポートします。
  - belongsToは一般的に対一ですが、親関係がhasManyの場合、対多もサポートします（hasMany/belongsToは実質的には多対多関係です）。

## 特殊な状況についての説明

### 「多対多」は「一対多/多対一」の組み合わせと等価です。

モデル

![20240411101558](https://static-docs.nocobase.com/20240411101558.png)

多対多の設定でデフォルト値変数を設定する際、変数に複数のレコードがある場合、選択したデータも複数になります。以下の図のようになります：
テーブルブロックのデータテーブルと関係フィールドのデータテーブルが同じ場合に使用します。
![20240411103021](https://static-docs.nocobase.com/20240411103021.png)

### なぜ一対一および一対多にはデフォルト値が設定できないのか？

例えば、A.B 関係において、b1 が a1 に関連付けられている場合、b1 は a2 に関連付けることができません。もし b1 が a2 に関連付けられた場合、a1 との関連が解除されます。このような場合、データは共有されず、デフォルト値は共有のメカニズム（すべてが関連付けられる）であるため、一対一および一対多にはデフォルト値を設定できません。

### なぜ多対一および多対多のサブフォームやサブテーブルにもデフォルト値が設定できないのか？

サブフォームやサブテーブルの焦点は、関係データを直接編集（追加や削除を含む）することにありますが、関係のデフォルト値は共有のメカニズムであり、すべてが関連付けられますが、関係データを変更することはできません。このため、このようなシナリオではデフォルト値を提供するのは適切ではありません。

また、サブフォームやサブテーブルにはサブフィールドがあり、サブフォームやサブテーブルのデフォルト値が行のデフォルト値か列のデフォルト値かが不明確になります。

総合的に考慮すると、どのような関係のサブフォームやサブテーブルにもデフォルト値を直接設定しない方が適切です。

