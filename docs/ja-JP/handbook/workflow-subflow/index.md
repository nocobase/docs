# サブフロー

<PluginInfo name="workflow-subflow" link="/handbook/workflow-subflow" commercial="true"></PluginInfo>

1つのワークフロー内で他のプロセスを呼び出すために使用され、現在のプロセスの変数をサブプロセスの入力として使用し、サブプロセスの出力を現在のプロセスの変数として後続ノードで使用します。

サブプロセスを呼び出す処理プロセスは以下の図に示されています：

![20241230134634](https://static-docs.nocobase.com/20241230134634.png)

サブプロセスを通じて、一部の一般的なプロセスロジック（例えば、メールやSMSの送信）を再利用したり、複雑なプロセスを複数のサブプロセスに分割して管理および保守を容易にできます。

## 使用マニュアル

本質的にワークフローは、プロセスがサブプロセスであるかどうかを区別しません。任意のワークフローは他のプロセスに呼び出されるサブプロセスとして使用でき、他のプロセスを呼び出すこともできます。すべてのワークフローは平等であり、呼び出しと呼び出される関係のみが存在します。

同様に、サブプロセスの使用は2つの位置に分かれます：

1. 主プロセス内：呼び出し側として、「ワークフローを呼び出す」ノードを通じて他のワークフローを呼び出します。
2. サブプロセス内：呼び出される側として、「プロセス出力」ノードを通じて、現在のプロセスで出力する必要のある変数を保存し、現在のプロセスを呼び出すワークフローで後続ノードが使用できます。

### ワークフーローを呼び出すノード

#### ノードを作成

ワークフロー設定インターフェースで、プロセス内のプラス（「+」）ボタンをクリックし、「ワークフローを呼び出す」ノードを追加します：

![ワークフローを呼び出すノードを追加](https://static-docs.nocobase.com/20241230001323.png)

#### ノードを設定

##### ワークフローを選択

呼び出すワークフローを選択します。検索ボックスを使用して素早く探すことができます：

![ワークフローを選択](https://static-docs.nocobase.com/20241230001534.png)

:::info{title=ヒント}
* 未使用のワークフローもサブプロセスとして呼び出すことができます。
* 現在のワークフローが同期モードの場合、同期モードのサブプロセスのみを呼び出すことができます。
:::

##### ワークフローのトリガー変数を設定

ワークフローを選定後、トリガーの変数を設定する必要があります。これはサブプロセスの入力データとなります。静的データを直接選択することも、現在のプロセス内の変数を選択することもできます：

![トリガー変数を設定](https://static-docs.nocobase.com/20241230162722.png)

異なるタイプのトリガーによって必要な変数は異なります。必要に応じてフォーム上で設定を完了させてください。

### プロセス出力ノード

#### ノードを作成

呼び出されるワークフロー内に「プロセス出力」ノードを追加します：

![20241231002033](https://static-docs.nocobase.com/20241231002033.png)

#### ノードを設定

##### 出力値

変数を入力または選択して出力値とし、出力値は任意の型（文字列、数字、論理値、日付、カスタムJSONなどの定数）を設定できます。また、プロセス内の他の変数は利用することもできます。

![20241231003059](https://static-docs.nocobase.com/20241231003059.png)

:::info{title=ヒント}
呼び出されるワークフローに複数の「プロセス出力」ノードが追加されている場合、呼び出し時には最後に実行された「プロセス出力」ノードの値を出力します。
:::

### プロセス出力の使用

主プロセスに戻り、呼び出されたワークフローの下の他のノードでサブプロセスの出力値を使用する場合、ワークフローのノードの結果を選択できます。サブプロセスが出力するのが単純な値（文字列、数字、論理値、日付（UTC形式の文字列）など）であれば、そのまま使用できます。複雑なオブジェクト（データシート内のオブジェクトなど）の場合は、先にJSON解析ノードを通じてマッピングした後、プロパティを使用することができます。それ以外の場合は、全体のオブジェクトとして使用することのみが可能です。

サブプロセスでプロセス出力ノードが設定されていない、または出力値がない場合、主プロセスで呼び出されたワークフローのノードの結果を使用する際には、空値（`null`）を得ることになります。