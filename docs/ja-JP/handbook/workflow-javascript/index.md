# ワークフロー - JavaScript

<PluginInfo name="workflow-script" link="/handbook/workflow-script" commercial="true"></PluginInfo>

スクリプトノードは、ワークフロー内でカスタマイズされた Node.js スクリプトを実行するためのノードです。このノードでは、ワークフロー上流の変数をパラメータとして利用でき、スクリプトの戻り値を下流のノードで使用することが可能です。

スクリプトは Node.js のほとんどの機能をサポートしていますが、ネイティブの実行環境とは一部異なる点があります。詳細は[機能リスト](#特性列表)をご覧ください。

## 使い方ガイド

### ノードの作成

ワークフローの設定画面で、「+」ボタンをクリックして「スクリプト」ノードを追加します。

![20241007122632](https://static-docs.nocobase.com/20241007122632.png)

### ノードの設定

![20241007122825](https://static-docs.nocobase.com/20241007122825.png)

#### パラメータ

スクリプトにワークフローのコンテキスト変数や静的値を渡すための設定です。`name` はパラメータ名であり、スクリプト内で変数名として使用されます。`value` はその値であり、変数や定数を指定することができます。

#### スクリプト内容

スクリプト内容は関数として扱われ、Node.js 環境でサポートされる任意の JavaScript コードを記述できます。`return` ステートメントを使用して値を返し、ノードの実行結果として後続のノードで使用できます。

コードを記述した後、エディタ下部のテストボタンを使用してテスト実行ダイアログを開きます。パラメータに静的値を入力してシミュレーションを行い、戻り値やログ出力を確認することが可能です。

![20241007153631](https://static-docs.nocobase.com/20241007153631.png)

#### タイムアウト設定

単位はミリ秒です。`0` を設定するとタイムアウトが無効になります。

#### スクリプトエラー後のワークフロー継続

このオプションを有効にすると、スクリプトエラーやタイムアウトエラーが発生しても後続のノードが実行されます。

:::info{title="ご注意"}
スクリプトがエラーになると戻り値がなくなり、ノードの結果にはエラーメッセージが格納されます。後続のノードでスクリプトノードの結果変数を使用する場合は、注意が必要です。
:::

## 機能リスト

### Node.js バージョン

メインアプリケーションと同じ Node.js バージョンが使用されます。

### モジュールサポート

スクリプトでは制限付きでモジュールを使用できます。CommonJS 標準に準拠しており、`require()` ディレクティブを使用してモジュールを読み込むことができます。

Node.js のネイティブモジュールや `node_modules` 内のインストール済みモジュール（NocoBase が使用している依存関係を含む）をサポートします。ただし、スクリプトノードで使用可能なモジュールはアプリケーションの環境変数 `WORKFLOW_SCRIPT_MODULES` で宣言する必要があります。複数のモジュール名はカンマ区切りで記述します。例:

```ini
WORKFLOW_SCRIPT_MODULES=crypto,timers,lodash,dayjs
```

:::info{title="ご注意"}
`WORKFLOW_SCRIPT_MODULES` に宣言されていないモジュールは、Node.js ネイティブモジュールやインストール済みモジュールであってもスクリプトで使用することはできません。このポリシーは、運用レベルでユーザーが使用可能なモジュールリストを制御し、スクリプト権限が過剰になるのを防ぐためのものです。
:::

### グローバル変数

`global`、`process`、`__dirname`、`__filename` などのグローバル変数は**サポートされていません**。

```js
console.log(global); // エラーが発生します: "global is not defined"
```

### 入力パラメータ

ノードで設定されたパラメータはスクリプト内でグローバル変数として利用可能です。渡されるパラメータは `boolean`、`number`、`string`、`object`、配列などの基本型のみサポートされます。`Date` オブジェクトは ISO 形式の文字列に変換されます。それ以外の複雑な型（カスタムクラスのインスタンスなど）は直接渡すことはできません。

### 戻り値

`return` ステートメントを使用して、基本型のデータ（パラメータと同じルール）をノードの結果として返すことができます。コードに `return` ステートメントがない場合、ノードの実行結果はありません。

```js
return 123;
```

### 出力（ログ）

`console` を使用してログを出力することが**可能**です。

```js
console.log('こんにちは、世界！');
```

スクリプトノードの出力は対応するワークフローのログファイルにも記録されます。

### 非同期処理

`async` と `await` を使用して非同期関数を定義することが**可能**です。また、グローバルオブジェクト `Promise` もサポートされています。

```js
async function test() {
  return Promise.resolve(1);
}

const value = await test();
return value;
```

### タイマー

`setTimeout`、`setInterval`、`setImmediate` などのメソッドを使用するには、Node.js の `timers` モジュールをインポートする必要があります。

```js
const { setTimeout, setInterval, setImmediate, clearTimeout, clearInterval, clearImmediate } = require('timers');

async function sleep(time) {
  return new Promise((resolve) => setTimeout(resolve, time));
}

await sleep(1000);

return 123;
```
