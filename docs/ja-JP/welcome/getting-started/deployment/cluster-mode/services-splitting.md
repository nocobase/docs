# サービス分割

通常、NocoBase アプリケーションのすべてのサービスは、単一の Node.js インスタンス上で動作します。アプリの機能が複雑になるにつれて、処理に時間がかかる一部のサービスが全体のパフォーマンスに影響を与える可能性があります。NocoBase は、クラスターモードでサービスを異なるノードに分散して実行できるようにすることで、単一サービスの問題がアプリ全体の応答性に影響するのを防ぎます。また、特定のサービスを水平スケールしてリソース効率を向上させることも可能です。

クラスターデプロイ時、NocoBase は各サービスを異なるノードに分けて動作させることができます。以下はその構成図です：

![20250803214857](https://static-docs.nocobase.com/20250803214857.png)

## サービスの分割方法

環境変数 `WORKER_MODE` を設定することで、各サービスを異なるノードに割り当てることができます：

- `WORKER_MODE=<空>`：すべてのリクエストとタスクを処理（単一インスタンスと同様）
- `WORKER_MODE=!`：リクエストのみ処理、バックグラウンドタスクは無効
- `WORKER_MODE=workflow:process,async-task:process`：指定したタスクのみ処理、リクエストは無効
- `WORKER_MODE=*`：すべてのタスクを処理、リクエストは無効
- `WORKER_MODE=!,workflow:process`：リクエストと指定タスクを処理
- `WORKER_MODE=-`：リクエスト・タスクともに処理しない（workerプロセス用）

Kubernetes 環境では、同じロールのノードに同じ設定を適用することで、簡単に水平スケーリングができます。

## 分割可能なサービス

### 非同期ワークフロー

**サービスキー**：`workflow:process`

非同期ワークフローはキューに入り順次処理され、ユーザーは結果を待つ必要がありません。複雑で負荷の高いワークフローは、専用ノードに分割するのが望ましいです。

### その他のユーザー向け非同期タスク

**サービスキー**：`async-task:process`

インポート・エクスポートなどの非同期処理。データ量が多いまたは高負荷時は専用ノードに分離すべきです。

## 設定例

### ノードごとの役割分離

3ノード (`node1`, `node2`, `node3`) の場合：

- `node1`：UI リクエストのみ – `WORKER_MODE=!`
- `node2`：ワークフローのみ – `WORKER_MODE=workflow:process`
- `node3`：非同期タスクのみ – `WORKER_MODE=async-task:process`

### ノードを混合利用

4ノード (`node1`〜`node4`) の場合：

- `node1`・`node2`：UI リクエスト処理 – `WORKER_MODE=!`
- `node3`・`node4`：全てのバックグラウンド処理 – `WORKER_MODE=*`

## 開発時の参考

リソースを多く消費するサービスを分割するには、次のように実装できます：

1. `my-plugin:process` のようなサービスキーを定義し、環境変数で指定できるようにする
2. プラグイン内で `app.serving()` を使って処理可否を判断

```javascript
const MY_PLUGIN_SERVICE_KEY = 'my-plugin:process';
if (this.app.serving(MY_PLUGIN_SERVICE_KEY)) {
  // 処理を実行
} else {
  // 処理をスキップ
}
