# 审批

审批是一种专用于人工发起且由人工处理以决定相关数据状态的流程形式。通常用于办公自动化或其他人工决策事务的流程管理，例如可以创建并管理“请假申请”、“费用报销审批”和“原料采购审批”等场景的人工流程。

审批插件提供了专用的工作流类型（触发器）“发起审批”和专用于该流程的“审批”节点，结合 NocoBase 特有的自定义数据表和自定义区块，可以快速且灵活地创建与管理各类审批场景。

## 安装

:::info{title=提示}
该插件为商业插件，请咨询开发团队获取。
:::

## 使用手册

### 审批触发器

#### 创建流程

创建工作流时选择“审批”类型，即可创建审批流程：

![审批触发器_创建审批流程](./approval-trigger-create-workflow.png)

之后在工作流配置界面中点击触发器打开弹窗进行更多的配置。

#### 绑定数据表

NocoBase 的审批插件基于灵活性的设计，可以与任意自定义数据表配合使用，即审批配置无需重复配置数据模型，而是直接复用已创建的数据表。所以在进入触发器配置后，首先需要选择数据表，以决定该流程由哪个数据表的数据创建或更新时触发：

![审批触发器_触发器配置_选择数据表](./approval-trigger-configuration-select-collection.png)

然后在对应数据表的创建（或编辑）数据的表单中将该工作流绑定到提交按钮上：

![发起审批_绑定工作流](./approval-initiate-bind-workflow.png)

之后用户对该表单的提交即可触发对应的审批工作流，提交的数据除了保存在对应的数据表中，也会被快照至审批流中，供后续审批人员查阅使用。

#### 发起审批的位置

在用户端界面有两个位置可以发起审批：一是通过已绑定的数据表的创建（或更新）数据表单提交发起，该位置通常只针对单一的审批流程发起；二是可以集中地从审批中心区块发起，通常针对于中心化管理的全局流程。

![审批触发器_触发器配置_选择发起审批的位置](./approval-trigger-configuration-select-place-to-initiate.png)

勾选“在数据区块和审批中心都可以发起和审批”后，该流程会在审批中心区块的“发起”按钮下拉菜单中出现，用户可以集中在该位置发起不同的审批。

#### 撤回

如果一个审批流程允许发起人撤回，可以勾选“允许撤回”的选项：

![审批触发器_触发器配置_允许撤回](./approval-trigger-configuration-withdrawable.png)

勾选后该流程发起的审批在任何审批人处理之前均可被发起人撤回，但在任何后续审批节点配置的审批人处理过后，将不再可被撤回。

#### 发起审批的表单界面配置

最后需要配置发起人的表单界面，该界面将用于从审批中心区块发起时和用户撤回后重新发起时的提交操作。点击配置按钮打开弹窗：

![审批触发器_触发器配置_发起人表单](./approval-trigger-configuration-intiator-ui.png)

可以为发起人的界面添加基于绑定的数据表的填写表单，或用以提示和引导的说明文案（Markdown）。其中表单是必须添加的，否则发起人进入到该界面后将无法操作。

添加表单区块后，和普通表单配置界面一样，可以添加对应数据表的字段组件，并且可以任意排列，以组织表单需要填写的内容：

![审批触发器_触发器配置_发起人表单_字段配置](./approval-trigger-configuration-intiator-ui-fields.png)

区别与直接提交的按钮，还可以增加“保存草稿”的操作按钮，用于支持暂存的处理流程：

![审批触发器_触发器配置_发起人表单_操作配置](./approval-trigger-configuration-intiator-ui-actions.png)

### 审批节点

在审批工作流中，需要使用专用的“审批”节点为审批人配置用于处理（通过、拒绝或退回）发起的审批的操作逻辑，“审批”节点也仅可在审批流程中使用。

:::info{title=提示}
与普通的“人工处理”节点的区别：普通的“人工处理”节点针对的场景更加泛化，可以用于更多类型的工作流的人工输入数据、人工决策流程是否继续等场景。“审批节点”是特化的专用于审批流程的处理节点，不能在其他工作流中使用。
:::

#### 创建节点

点击流程中的加号（“+”）按钮，添加“审批”节点，再选择其中一种通过模式，创建审批节点：

![审批节点_创建](./approval-node-create.png)

#### 通过模式

通过模式有两种：

1.  直通模式：通常用于较为简单的流程，审批节点通过与否只决定流程是否结束，未通过的情况下直接退出流程。

    ![审批节点_通过模式_直通模式](./approval-node-branch-mode-passthrough.png)

2.  分支模式：通常用于更复杂的数据逻辑，审批节点产生任何结果后，可在其结果分支内继续执行其他节点。

    ![审批节点_通过模式_分支模式](./approval-node-branch-mode-branched.png)

    其中如果节点配置了“退回”操作，才会产生“退回”分支，且退回分支执行完以后会强制退出当前流程。

    该节点被“通过”后，除执行通过分支，也会继续执行后续流程。“拒绝”操作后默认也可以继续执行后续流程，也可以在节点中配置执行分支后结束流程。

:::info{title=提示}
通过模式在节点创建后不可修改。
:::

#### 审批人

审批人是负责该节点审批行为的用户集合，可以是一个或多个用户，选择的来源可以是从用户列表选择的静态值，也可以是由变量指定的动态值。

![审批节点_审批人](./approval-node-assignees.png)

选择变量时，仅可选择上下文和节点结果中用户数据的主键或外键。如果选择的变量在执行中是数组（对多关系），那么数组中的每个用户都会合并到整个审批人集合中。

#### 协商模式

如果审批人在最终执行时只有一个（包含多个变量去重后的情况），那么无论选择何种协商模式，都只由该用户执行审批操作，结果也仅由该用户决定。

当审批人集合中有多个用户时，选择不同协商模式代表不同的处理方式：

1. 或签：只需其中一人通过即代表节点通过，所有人都拒绝才代表节点拒绝。
2. 会签：需要所有人通过才代表节点通过，只需其中一人拒绝即代表节点拒绝。
3. 投票：需要超过设定比例的人数通过才代表节点通过，否则代表节点拒绝。

针对退回操作，在任何模式下，如果审批人集合中有人处理为退回，那么节点会直接退出流程。

#### 处理顺序

同样的，在审批人集合中有多个用户时，选择不同的处理顺序代表不同的处理方式：

1. 并行：所有审批人可以以任意顺序处理，先后处理无关。
2. 顺序：审批人按照审批人集合中的顺序依次处理，审批人中的上一个提交后，下一个才能处理。

无论是否设置为“顺序”处理，根据实际处理的先后顺序产生的结果也遵循上述“协商模式”中的规则，达到对应条件后该节点即完成执行。

#### 拒绝分支结束后退出工作流

“通过模式”设置为“分支模式”时，可以选择在拒绝分支结束后退出工作流。勾选以后，拒绝分支的末尾会显示一个“✗”，表示该分支结束后不再继续后续节点：

![审批节点_拒绝后退出](./approval-node-exit-on-rejection.png)

#### 审批人界面配置

审批人界面配置用于提供审批人对审批工作流执行到该节点时的操作界面，点击配置按钮打开弹窗：

![审批节点_界面配置_弹窗](./approval-node-ui-drawer.png)

在配置弹窗中可以添加提交审批的详情、操作栏和自定义提示文字等区块：

![审批节点_界面配置_添加区块](./approval-node-ui-blocks.png)

其中审批内容详情区块即发起人提交的数据区块，与普通的数据区块类似，可以任意添加数据表的字段组件，并且可以任意排列，以组织审批人需要查看的内容：

![审批节点_界面配置_详情区块](./approval-node-ui-blocks-details.png)

操作栏中可以添加该节点支持的操作按钮，例如“通过”、“拒绝”和“退回”等：

![审批节点_界面配置_操作栏](./approval-node-ui-blocks-actions.png)

另外，操作栏中也可以添加相关的字段要求审批人填写，如“评论”字段。

:::warning{title=重要}
如果开启或关闭了某个操作按钮，需要在关闭操作界面配置的弹窗后保存该节点的配置，否则该操作按钮的变动不会生效。
:::

### 发起审批配置

在配置好一个审批工作流并启用后，可以将该工作流绑定在对应的数据表的表单提交按钮上，以供用户在提交的时候发起审批：

![发起审批_绑定工作流](./approval-initiate-bind-workflow.png)

绑定工作流后，用户在提交当前表单时，即发起审批。

### 数据详情中的审批区块

在已提交的数据详情弹窗中，可以配置审批区块，用于展示对应数据的审批记录，以及处理入口：

![详情审批区块_创建区块](./approval-record-detail-create-approval-block.png)

#### 发起人处理

审批区块中会展示基本的申请信息，以及审批处理记录。对于发起人，可以在弹窗中查看自己发起的申请内容详情，如果配置了可被撤回，且流程在进入首个审批节点后但还未被任何审批人处理，可以撤回已发起的申请：

![详情审批区块_发起人查看](./approval-record-detail-application-content.png)

如果发起人执行了撤回操作，会在审批区块中显示撤回的记录，并且可以点击查看后会重新打开申请的弹窗：

![详情审批区块_发起人撤回后再次查看](./approval-record-detail-withdrawn.png)

弹窗中的内容与之前的内容一致，可以修改后再次提交：

![详情审批区块_发起人撤回后再次提交](./approval-record-detail-withdrawn-resubmit.png)

#### 审批人处理

审批人同样通过该区块查看审批的内容详情，在处理记录的节点列表中，如果当前登录用户为该节点的负责人之一，会在详情列中显示“查看”按钮，点击后会打开审批的弹窗：

![详情审批区块_审批人处理节点](./approval-record-detail-assignee-view.png)

弹窗中将展示该审批节点中配置的审批人界面，通常会包含审批内容详情和操作栏：

![详情审批区块_审批人处理弹窗](./approval-record-detail-assignee-drawer.png)

审批人可以在弹窗中执行通过、拒绝或退回操作，操作后会在处理记录中生成对应的记录，如果操作是退回，则发起人可以再次修改申请内容后重新发起：

![详情审批区块_审批人退回](./approval-record-detail-returned.png)

通过或拒绝会根据节点配置的对应规则产生相应的状态：

![详情审批区块_审批人通过](./approval-record-detail-passed.png)

### 审批中心区块

审批插件提供了两个全局区块用于集中地管理部分审批流程，分别是“发起审批”和“审批待办”：

![审批中心区块_创建](./approval-blocks-create.png)

“发起审批”区块用于发起人的视角，可以从区块的操作栏发起新的审批：

![审批中心区块_发起审批](./approval-blocks-initiate.png)

如果在审批触发器中配置了“在数据区块和审批中心都可以发起和审批”，那么在“申请”按钮的下拉菜单中会出现对应的审批流程。

当然，也可以在列表中查看已发起的审批的状态：

![审批中心区块_查看发起列表](./approval-blocks-initiations-list.png)

点击“查看”打开的弹窗与数据详情中的审批区块内容类似，区别是发起人提交的内容和审批历史分别在不同的标签页展示：

![审批中心区块_发起人查看详情](./approval-blocks-initiation-view.png)

“审批待办”区块用于审批人视角，可以在列表中查看待处理的审批，点击对应的“查看”按钮将打开处理弹窗，与数据详情中的审批区块内容类似，区别是审批人的处理表单和审批历史分别在不同的标签页展示：

![审批中心区块_审批人查看已处理的详情](./approval-blocks-assignee-view-processed.png)

如果是已处理过的，将以提交处理的内容展示，且不可修改。
