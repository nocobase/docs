# 扩展开发

工作流从内置的功能来说不是全能的，比如内置的节点类型无法穷举所有业务场景中的每一种操作，所以我们还提供了对工作流进行扩展的设计，包括扩展触发器与节点类型等方面，遇到内置功能无法满足的业务场景，可以通过低代码的方式扩展解决。

## 基础引擎

工作流引擎也是一个微内核架构，核心仅为一个自动状态机的设计，可根据具体配置按顺序进行节点指令的处理。同时考虑流程的应用场景（如人工介入等），从底层的状态设计上亦支持临时中断与恢复。部分内置的节点类型也是基于这些内核设计，扩展出条件、分支等流程控制能力。

工作流在配置和运行时的基础数据建模如下图：

<img src="./workflow-modeling.svg" style="max-width: 600px;" />

- 一个工作流（workflow）有若干个流程节点（node），每个节点对应特定的操作指令。
- 多个节点之间有上下游和分支关系，组成树状结构，分支的流向有开启分支的节点指令内容决定。
- 一个工作流可以有多次触发，每次触发会创建一个新的流程实例（execution），用于跟踪执行状态。
- 每次触发执行，根据流程经过的节点，会有若干个任务（job），以记录每个节点的执行状态和结果。

可以将工作流的配置理解为模板，每一次触发就根据该模板创建一个新的执行实例，用于跟踪执行状态。而节点也相当于任务的模板，流程经过节点则会创建一个对应的任务，用于记录节点执行的状态和数据结果。

## 执行流程

在一个工作流被触发后，引擎（执行器）会根据配置的节点顺序，依次执行每个节点代表的指令和操作。每个节点执行后都会返回以下其中一种状态：

| 常量                  | 数据值 | 含义                                     |
| --------------------- | ------ | ---------------------------------------- |
| `JOB_STATUS.RESOLVED` | `1`    | 成功：该节点已执行成功                   |
| `JOB_STATUS.REJECTED` | `-1`   | 失败：该节点已执行失败（报错或业务拒绝） |
| `JOB_STATUS.PENDING`  | `0`    | 停等：已执行到该节点，但指令要求挂起等待 |

节点的执行状态会影响整个流程的成功或失败，通常在没有分支的情况下，某个节点的失败会直接导致整个流程失败。其中最常规的情况是，节点执行成功则继续节点表中的下一个节点，直到没有后续节点，则整个工作流执行以成功的状态完成。

如果执行中某个节点返回了执行失败的状态，则视以下两种情况引擎会有不同的处理：

1.  返回失败状态的节点处于主流程，即均未处于上游的节点开启的任意分支流程之内，则整个主流程会判定为失败，并退出流程。

2.  返回失败状态的节点处于某个分支流程之内，此时将判定流程下一步状态的职责交由开启分支的节点，由该节点的内部逻辑决定后续流程的状态，并且递归上溯到主流程。

最终都在主流程的节点上得出整个流程的下一步状态，如果主流程的节点中返回的是失败，则整个流程以失败的状态结束。

如果任意节点执行后返回了“停等”状态，则整个执行流程会被暂时中断挂起，等待一个由对应节点定义的事件触发以恢复流程的执行。例如审批类型的节点处理，会以“停等”状态从该节点暂停，等待人工介入该流程，决策是否通过。如果人工输入的状态是通过，则继续后续的流程节点，反之则按前面的失败逻辑处理。

对应的，整个工作流在触发后执行实例的状态有以下几种：

| 常量名                      | 值   | 含义       |
| --------------------------- | ---- | ---------- |
| `EXECUTION_STATUS.STARTED`  | `0`  | 执行中     |
| `EXECUTION_STATUS.RESOLVED` | `1`  | 已执行成功 |
| `EXECUTION_STATUS.REJECTED` | `-1` | 已执行失败 |

在触发后未执行完毕或某个节点返回“停等”状态的情况下，执行实例的状态都是“执行中”。直到主流程中产生终态（成功或失败）的节点，整个执行实例的状态才会被更新为对应的终态，代表执行结束。
